<?xml version="1.0" encoding="utf-8"?><feed xmlns="http://www.w3.org/2005/Atom" xml:lang="zh-CN"><title type="text">loomt</title><subtitle type="html">记录生活与coding</subtitle><updated>2023-02-08T14:45:11+00:00</updated><id>https://loomt.top/</id><link rel="alternate" type="text/html" href="https://loomt.top/"/><link rel="self" type="application/atom+xml" href="https://loomt.top/atom.xml"/><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><generator uri="https://gohugo.io/" version="0.92.2">Hugo</generator><entry><title type="text">6.824 Lab1</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/6.824-lab1/"/><id>https://loomt.top/posts/6.824-lab1/</id><updated>2023-02-08T22:36:56+08:00</updated><published>2023-02-03T23:25:54+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">Lab1 MapReduce EndTime: 2023/2/3 Paper MapReduce: Simplified Data Processing on Large Clusters MapReduce 将分布式系统处理数据的细节（并行、容错、局部性优化、负载均衡等）隐藏起来，提供一套简化方案，解决了在多台机器处理大量逻辑简单的计算（分…</summary><content type="html">&lt;h2 id="lab1-mapreduce">Lab1 MapReduce&lt;/h2>
&lt;blockquote>
&lt;p>EndTime: 2023/2/3&lt;/p>
&lt;/blockquote>
&lt;h3 id="paper">Paper&lt;/h3>
&lt;p>&lt;a href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf">MapReduce: Simplified Data Processing on Large Clusters&lt;/a>&lt;/p>
&lt;p>MapReduce 将分布式系统处理数据的细节（并行、容错、局部性优化、负载均衡等）隐藏起来，提供一套简化方案，解决了在多台机器处理大量逻辑简单的计算（分布式计算）实现复杂的问题。&lt;/p>
&lt;h3 id="实现">实现&lt;/h3>
&lt;p>本实验可以由1个 coordinator/master 调度若干个 worker。先完成所有 map 任务，生成中间键值对并将其存在中间文件后再进行 reduce 任务，最后将 reduce 任务的结果输出到文本。&lt;/p>
&lt;p>需要我们修改的文件为 &lt;code>mr/*&lt;/code>&lt;/p>
&lt;ol>
&lt;li>worker 通过 RPC 循环请求任务。&lt;/li>
&lt;li>coordinator 读取 8 个给定的文件分给不同的 worker 进行 map 任务，这部分如果喜欢也可以按固定 bytes 进行切割&lt;del>但我懒得处理了&lt;/del>。&lt;/li>
&lt;li>worker 读取文件并扔给&lt;code>fmap&lt;/code>进行处理，生成中间键值对，计算字符串的 hash 后将&lt;code>key-intermediate_value&lt;/code>存在 &lt;code>mr-taskid-ihash(str)&lt;/code> 里面。&lt;/li>
&lt;/ol>
&lt;blockquote>
&lt;p>fmap 函数通过编译生成的 *.so 调用&lt;/p>
&lt;/blockquote>
&lt;style type="text/css">.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media (prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}&lt;/style>
&lt;div>&lt;svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg">&lt;symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/>&lt;/symbol>&lt;symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>&lt;/symbol>&lt;symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>&lt;/symbol>&lt;symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/>&lt;/symbol>&lt;/svg>&lt;/div>&lt;div class="notice tip" >
&lt;p class="first notice-title">&lt;span class="icon-notice baseline">&lt;svg>&lt;use href="https://loomt.top/posts/6.824-lab1/#tip-notice">&lt;/use>&lt;/svg>&lt;/span>提示&lt;/p>&lt;p>看到一些同学是先 os.CreateTemp(&amp;quot;&amp;quot;, tmpFileName) 存在临时文件里面，等处理完了再 rename 成&lt;code>mr-taskid-ihash(str)&lt;/code>。这样可能会更加规范一些，但不创建 tempfile 理论上应该也是正确的。&lt;/p>
&lt;p>当文件没完全写完 worker 就 crash 时，这个任务会被 coordinator 发现并交给别的 worker 重做。因为用的是&lt;code>os.Create()&lt;/code>，文件会被新的覆盖，直到 worker 成功完成任务为止。&lt;/p>
&lt;p>如果逻辑允许两个 worker 同时处理一个任务的话，就需要创建 tempFile 再 rename 的方式，因为需要保证创建的（临时）文件内容不重复。&lt;/p>&lt;/div>
&lt;ol start="4">
&lt;li>map 任务全部完成后 coordinator 分配 NReduce 个 reduce 任务给不同的 worker 处理。&lt;/li>
&lt;li>worker读取中间文件，并将&lt;code>key-list(intermediate_value)&lt;/code>扔给&lt;code>freduce&lt;/code>处理成&lt;code>key-value&lt;/code> 写入&lt;code>mr-out-ihash(str)&lt;/code>。&lt;/li>
&lt;li>coordinator 发现任务全都处理完后踢走 worker ，并在若干秒后退出。&lt;/li>
&lt;/ol>
&lt;h3 id="tips">Tips&lt;/h3>
&lt;ol>
&lt;li>
&lt;p>结构&lt;/p>
&lt;ul>
&lt;li>
&lt;p>go 可以用 const 和 iota 代替 enum。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>WorkerInfo 在这个实验可以省略，不需要保留 worker 的状态，但我写了就不想删了。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>本来还想往结构体内置一个 logger 的，但RPC调用需要gob序列化，而 logger 不知道为啥会序列化失败，不知道是啥 bug ，以后再瞅瞅。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="kd">const&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">_&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="kc">iota&lt;/span>
&lt;span class="c1">// MAP REDUCE WAIT: Task type
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">MAP&lt;/span>
&lt;span class="nx">REDUCE&lt;/span>
&lt;span class="nx">WAIT&lt;/span>
&lt;span class="c1">// IDLE BUSY DONE: Task status || WorkerInfo status
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">IDLE&lt;/span>
&lt;span class="nx">BUSY&lt;/span>
&lt;span class="nx">DONE&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Coordinator&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">NMap&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// map 任务的个数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">NReduce&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// reduce 任务的个数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">DMap&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// 记录map task完成的个数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">DReduce&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// 记录reduce task完成的个数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">WorkerId&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// 为新的worker分配workerIds
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">TaskDone&lt;/span> &lt;span class="kd">map&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="kt">int&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="kt">bool&lt;/span> &lt;span class="c1">// 记录task是否被完成
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Map&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Task&lt;/span> &lt;span class="c1">// 待取出的map task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Reduce&lt;/span> &lt;span class="kd">chan&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">Task&lt;/span> &lt;span class="c1">// 待取出的reduce task
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">TaskMutex&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// 用于任务分发相关数据的mutex
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">DoneMutex&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// 用于完成任务相关数据的mutex
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Mutex&lt;/span> &lt;span class="nx">sync&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span> &lt;span class="c1">// 用于其他细节的mutex
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">Task&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">StartTime&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Time&lt;/span>
&lt;span class="nx">NReduce&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// 传给worker，用于ihash 的mod
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Type&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// MAP REDUCE WAIT
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Status&lt;/span> &lt;span class="kt">int&lt;/span> &lt;span class="c1">// IDLE BUSY DONE
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">FileName&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">TaskId&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">WorkerId&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="nx">WorkerInfo&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">WorkerId&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">TaskId&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="nx">Status&lt;/span> &lt;span class="kt">int&lt;/span>
&lt;span class="c1">//Lg *log.Logger
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//Why this error?
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//gob: type log.Logger has no exported fields
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//2023/01/31 14:34:13 RPC getWork failed
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//exit status 1
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="p">}&lt;/span>
&lt;span class="c1">// Map functions return a slice of KeyValue.
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="kd">type&lt;/span> &lt;span class="nx">KeyValue&lt;/span> &lt;span class="kd">struct&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Key&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="nx">Value&lt;/span> &lt;span class="kt">string&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>RPC写入reply的时候不能直接将reply指向一个新的地址，而是要修改reply地址的值。&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go"> &lt;span class="c1">//reply = &amp;amp;GetWorkReply{&amp;amp;Task{...}}
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//上面的方法不会返回想要的reply，因为reply指向的是新的GetWorkReply值在rpc服务器的指针。这部分客户端的内存和服务器的不一样，所以得到的是空值；下面的方法因为 reply是共享内存的，所以服务器和客户端都可以访问 &amp;amp;reply。
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">//在RPC调用时，要避免传递指针参数，如果传递的参数是值类型，那么这个值将会被复制到另一个地址
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="o">*&lt;/span>&lt;span class="nx">reply&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="nx">GetWorkReply&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="nx">Task&lt;/span>&lt;span class="p">{&lt;/span>
&lt;span class="nx">StartTime&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Now&lt;/span>&lt;span class="p">(),&lt;/span>
&lt;span class="nx">Type&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">MAP&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">Status&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">BUSY&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">FileName&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mapTask&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileName&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">NReduce&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">NReduce&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">WorkerId&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">args&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">WorkerId&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="nx">TaskId&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">mapTask&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaskId&lt;/span>&lt;span class="p">,&lt;/span>
&lt;span class="p">}}&lt;/span> &lt;span class="c1">// equal to reply.Task = &amp;amp;Task{...}
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>clash test，需要coordinator在worker宕机10s后为同一个任务重新分配worker,这部分需要考虑一下注意一下 data race&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="k">go&lt;/span> &lt;span class="kd">func&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">taskId&lt;/span> &lt;span class="kt">int&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">filename&lt;/span> &lt;span class="kt">string&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">select&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="k">case&lt;/span> &lt;span class="o">&amp;lt;-&lt;/span>&lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">After&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="mi">12&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="nx">time&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Second&lt;/span>&lt;span class="p">):&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Lock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">!&lt;/span>&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaskDone&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="nx">taskId&lt;/span>&lt;span class="p">]&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">dosomething&lt;/span>
&lt;span class="p">}&lt;/span> &lt;span class="k">else&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">c&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">Mutex&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nf">Unlock&lt;/span>&lt;span class="p">()&lt;/span>
&lt;span class="nx">dootherthing&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="c1">// default:{
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// }
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="c1">// default不能写，如果写了就会直接跳到default，不会进入12s的case
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="k">return&lt;/span>
&lt;span class="p">}(&lt;/span>&lt;span class="nx">maptask&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">TaskId&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">mapTask&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">FileName&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>并发编程细节&lt;/li>
&lt;/ol>
&lt;p>因为 MapReduce 的特性，map task 可以并发，reduce task 可以并发，但两种任务不能同时并发，所以需要等到 map task 跑完才可以进行 reduce task。如果同时读写同一个变量，需要加锁。其实还可以用 chan 实现 lock-free ，以后试试，如果有时间的话。&lt;/p>
&lt;ol start="5">
&lt;li>贴一下测试的 makefile&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-makefile" data-lang="makefile">&lt;span class="c"># location: src/Makefile
&lt;/span>&lt;span class="c">&lt;/span>&lt;span class="nv">ntest&lt;/span> &lt;span class="o">:=&lt;/span> &lt;span class="m">50&lt;/span>
&lt;span class="nf">lab1&lt;/span>&lt;span class="o">:&lt;/span>
@cd main&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">for&lt;/span> i in &lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>seq &lt;span class="m">1&lt;/span> &lt;span class="k">$(&lt;/span>ntest&lt;span class="k">)&lt;/span>&lt;span class="o">)&lt;/span> &lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> bash test-mr.sh &amp;gt; res&lt;span class="nv">$$&lt;/span>i&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">done&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">cnt&lt;/span>&lt;span class="o">=&lt;/span>0&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">for&lt;/span> i in &lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>seq &lt;span class="m">1&lt;/span> &lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>expr &lt;span class="k">$(&lt;/span>ntest&lt;span class="k">)&lt;/span> - 1&lt;span class="o">))&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">do&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">if&lt;/span> cmp res&lt;span class="nv">$$&lt;/span>i res&lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>expr &lt;span class="nv">$$&lt;/span>i + 1&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nv">cnt&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>expr &lt;span class="nv">$$&lt;/span>cnt + 1&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">fi&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">done&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;same file num:&amp;#34;&lt;/span>&lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>expr &lt;span class="nv">$$&lt;/span>cnt + 1&lt;span class="o">)&lt;/span> &lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="o">[&lt;/span> &lt;span class="nv">$$&lt;/span>cnt -eq &lt;span class="nv">$$&lt;/span>&lt;span class="o">(&lt;/span>expr &lt;span class="k">$(&lt;/span>ntest&lt;span class="k">)&lt;/span> - 1&lt;span class="o">)&lt;/span> &lt;span class="o">]&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="k">then&lt;/span> &lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;****************************************************************&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;all res is the same!&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;result content as follow.&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;****************************************************************&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> cat main/res1&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;****************************************************************&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>&lt;span class="se">\
&lt;/span>&lt;span class="se">&lt;/span> &lt;span class="k">fi&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="6">
&lt;li>result&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>same file num:50
****************************************************************
all res is the same!
result content as follow.
****************************************************************
*** Starting wc test.
--- wc test: PASS
*** Starting indexer test.
--- indexer test: PASS
*** Starting map parallelism test.
--- map parallelism test: PASS
*** Starting reduce parallelism test.
--- reduce parallelism test: PASS
*** Starting job count test.
--- job count test: PASS
*** Starting early exit test.
--- early exit test: PASS
*** Starting crash test.
--- crash test: PASS
*** PASSED ALL TESTS
****************************************************************
&lt;/code>&lt;/pre></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/></entry><entry><title type="text">6.824</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/6.824/"/><id>https://loomt.top/posts/6.824/</id><updated>2023-02-08T22:36:56+08:00</updated><published>2023-01-17T23:11:57+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">MIT 6.824（现在好像变成了6.5840 schedule go并发编程 lab1 solution</summary><content type="html">&lt;h1 id="mit-6824现在好像变成了65840">MIT 6.824（现在好像变成了6.5840&lt;/h1>
&lt;p>&lt;a href="https://pdos.csail.mit.edu/6.824/schedule.html">schedule&lt;/a>
&lt;a href="https://www.youtube.com/watch?v=IdCbMO0Ey9I">go并发编程&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://www.loomt.top/posts/6.824-lab1">lab1 solution&lt;/a>&lt;/p></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/></entry><entry><title type="text">RPC</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/rpc/"/><id>https://loomt.top/posts/rpc/</id><updated>2023-01-17T21:03:56+08:00</updated><published>2023-01-15T21:47:06+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">RPC Remote Procedure Call 特点 区别于HTTP服务的RESTful风格接口，RPC主要是远程函数调用，HTTP则更关注与资源。并且RPC服务可以减少网络开销，各种意义上提高效率。 一…</summary><content type="html">&lt;h2 id="rpc">RPC&lt;/h2>
&lt;blockquote>
&lt;p>Remote Procedure Call&lt;/p>
&lt;/blockquote>
&lt;h3 id="特点">特点&lt;/h3>
&lt;p>区别于HTTP服务的RESTful风格接口，RPC主要是远程函数调用，HTTP则更关注与资源。并且RPC服务可以减少网络开销，各种意义上提高效率。&lt;/p>
&lt;p>一言以蔽之，RPC协议的主要目的是做到不同服务间调用方法像同一服务间调用本地方法一样&lt;/p>
&lt;h3 id="优点">优点&lt;/h3>
&lt;ol>
&lt;li>单一责任&lt;/li>
&lt;li>扩展性&lt;/li>
&lt;li>故障隔离&lt;/li>
&lt;/ol>
&lt;p>一言以蔽之，RPC协议的主要目的是做到不同服务间调用方法像同一服务间调用本地方法一样。&lt;/p>
&lt;h3 id="问题">问题&lt;/h3>
&lt;p>服务宕机&lt;/p>
&lt;p>网络异常&lt;/p>
&lt;p>服务时长不合预期&lt;/p>
&lt;h3 id="理论">理论&lt;/h3>
&lt;h4 id="论文架构">论文架构&lt;/h4>
&lt;p>User, User-Stub, RPC-Runtime, Server-Stub, Server&lt;/p>
&lt;p>&lt;img src="https://loomt.top/img/Implementing-remote-procedure-calls.png" alt="Implementing-remote-procedure-calls">&lt;/p>
&lt;h3 id="实现">实现&lt;/h3>
&lt;p>&lt;img src="https://loomt.top/img/rpc-real.png" alt="rpc-real">&lt;/p>
&lt;h4 id="idl-interface-description-language">IDL (Interface description language)&lt;/h4>
&lt;p>Descript the interface.&lt;/p>
&lt;h5 id="tlv编码">TLV编码&lt;/h5>
&lt;ul>
&lt;li>Tag：类型&lt;/li>
&lt;li>Length：长度&lt;/li>
&lt;li>Value：值（也可以是TLV结构）
&lt;img src="https://loomt.top/img/IDL-TLV.png" alt="IDL-TLV">&lt;/li>
&lt;/ul>
&lt;h4 id="gencode">GenCode&lt;/h4>
&lt;p>Translate the IDL to different programming language.&lt;/p>
&lt;p>Need decode and encode logic.&lt;/p>
&lt;p>兼容性——增加新的字段不影响现有服务&lt;/p>
&lt;p>通用性——跨平台跨语言&lt;/p>
&lt;p>性能——空间时间维度，编码后的数据大小和编码时长&lt;/p>
&lt;h4 id="encode">Encode&lt;/h4>
&lt;p>Conv code to byte.&lt;/p>
&lt;h4 id="protocol">Protocol&lt;/h4>
&lt;p>Necessary data and metadata&lt;/p>
&lt;p>0 1 2 3 4 5 6 7 8 9 a b c d e f 0 1 2 3 4 5 6 7 8 9 a b c d e f
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| 0| LENGTH |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| 0| HEADER MAGIC | FLAGS |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| SEQUENCE NUMBER |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| 0| Header Size(/32) | &amp;hellip;
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&lt;/p>
&lt;pre>&lt;code> Header is of variable size:
(and starts at offset 14)
&lt;/code>&lt;/pre>
&lt;p>+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| PROTOCOL ID (varint) | NUM TRANSFORMS (varint) |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| TRANSFORM 0 ID (varint) | TRANSFORM 0 DATA &amp;hellip;
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| &amp;hellip; &amp;hellip; |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| INFO 0 ID (varint) | INFO 0 DATA &amp;hellip;
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| &amp;hellip; &amp;hellip; |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+
| |
| PAYLOAD |
| |
+&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;&amp;mdash;-+&lt;/p>
&lt;p>LENGTH: 数据包大小，不包含自身&lt;/p>
&lt;p>HEADER MAGIC:标识版本信息，协议解析时快速校验&lt;/p>
&lt;p>SEQUENCE NUMBER:表示数据包的seqlD，可用于多路复用，单连接内递增&lt;/p>
&lt;blockquote>
&lt;p>多路复用(multiplexing) 在单个通信信道上传输多个信息。它可以让多个应用程序或进程在同一时间共享一个信道。以有效地利用带宽和资源，提高系统的效率。常见技术：时分多路复用TDM，波分多路复用WDM，包交换。一般通过TCP/IP实现。&lt;/p>
&lt;/blockquote>
&lt;p>HEADER SIZE:头部长度，从第14个字节开始计算一直到PAYLOAD前
PROTOCOL ID:编解码方式，有Binary和Compact两种
TRANSFORM ID:压缩方式，如zlilb 和snappy
INFO ID:传递一些定制的meta信息
PAYLOAD:消息体&lt;/p>
&lt;h4 id="network-transfer">Network Transfer&lt;/h4>
&lt;pre tabindex="0">&lt;code>Application Layer
Sockets API
TCP/UDP
IP
Driver
Physical Layer
&lt;/code>&lt;/pre>&lt;p>&lt;img src="https://loomt.top/img/socket.png" alt="socket">&lt;/p>
&lt;h3 id="rpc框架">RPC框架&lt;/h3>
&lt;p>&lt;em>reference&lt;/em>&lt;/p>
&lt;p>&lt;a href="http://ddia.vonng.com/#/ch4?id=%e6%9c%8d%e5%8a%a1%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e6%b5%81%ef%bc%9arest%e4%b8%8erpc">http://ddia.vonng.com/#/ch4?id=%e6%9c%8d%e5%8a%a1%e4%b8%ad%e7%9a%84%e6%95%b0%e6%8d%ae%e6%b5%81%ef%bc%9arest%e4%b8%8erpc&lt;/a>&lt;/p></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/></entry><entry><title type="text">go-zero单体服务</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/go-zero%E5%8D%95%E4%BD%93%E6%9C%8D%E5%8A%A1/"/><id>https://loomt.top/posts/go-zero%E5%8D%95%E4%BD%93%E6%9C%8D%E5%8A%A1/</id><updated>2023-02-08T14:45:05+00:00</updated><published>2023-01-08T09:46:11+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">go-zero go-zero简介 go-zero是一个能够快速生成API，MODEL和RPC的框架。 go-zero 项目结构（不含RPC） 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25…</summary><content type="html">&lt;h2 id="go-zero">go-zero&lt;/h2>
&lt;h3 id="go-zero简介">go-zero简介&lt;/h3>
&lt;p>&lt;a href="https://go-zero.dev/cn/docs/introduction">go-zero&lt;/a>是一个能够快速生成API，MODEL和RPC的框架。&lt;/p>
&lt;h3 id="go-zero-项目结构不含rpc">go-zero 项目结构（不含RPC）&lt;/h3>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">.
├── api
│   ├── etc
│   │   └── park-api.yaml
│   ├── internal
│   │   ├── config
│   │   │   └── config.go
│   │   ├── handler
│   │   │   ├── accessHandler.go
│   │   │   ├── deviceInfoHandler.go
│   │   │   ├── incomeHandler.go
│   │   │   ├── parkingLotHandler.go
│   │   │   ├── routes.go
│   │   │   ├── siteInfoHandler.go
│   │   │   ├── touristCarProvinceHandler.go
│   │   │   ├── touristFlowHandler.go
│   │   │   ├── userHandler.go
│   │   │   └── wechatHandler.go
│   │   ├── logic
│   │   │   ├── accessLogic.go
│   │   │   ├── deviceInfoLogic.go
│   │   │   ├── incomeLogic.go
│   │   │   ├── parkingLotLogic.go
│   │   │   ├── siteInfoLogic.go
│   │   │   ├── touristCarProvinceLogic.go
│   │   │   ├── touristFlowLogic.go
│   │   │   ├── userLogic.go
│   │   │   └── wechatLogic.go
│   │   ├── svc
│   │   │   └── serviceContext.go
│   │   └── types
│   │   └── types.go
│   ├── park.api
│   ├── park.go
│   └── park.md
├── genModel
│   ├── model
│   │   ├── accessModel.go
│   │   ├── accessModel_gen.go
│   │   ├── deviceInfoModel.go
│   │   ├── deviceInfoModel_gen.go
│   │   ├── incomeModel.go
│   │   ├── incomeModel_gen.go
│   │   ├── logErrModel.go
│   │   ├── logErrModel_gen.go
│   │   ├── parkingLotModel.go
│   │   ├── parkingLotModel_gen.go
│   │   ├── siteInfoModel.go
│   │   ├── siteInfoModel_gen.go
│   │   ├── touristCarProvinceModel.go
│   │   ├── touristCarProvinceModel_gen.go
│   │   ├── touristFlowModel.go
│   │   ├── touristFlowModel_gen.go
│   │   ├── userModel.go
│   │   ├── userModel_gen.go
│   │   ├── vars.go
│   │   ├── wechatModel.go
│   │   └── wechatModel_gen.go
│   └── resources
│   ├── genModel.sh
│   └── park.sql
├── go.mod
├── go.sum
└── model
├── accessModel.go
├── accessModel_gen.go
├── deviceInfoModel.go
├── deviceInfoModel_gen.go
├── incomeModel.go
├── incomeModel_gen.go
├── logErrModel.go
├── logErrModel_gen.go
├── parkingLotModel.go
├── parkingLotModel_gen.go
├── siteInfoModel.go
├── siteInfoModel_gen.go
├── touristCarProvinceModel.go
├── touristCarProvinceModel_gen.go
├── touristFlowModel.go
├── touristFlowModel_gen.go
├── userModel.go
├── userModel_gen.go
├── vars.go
├── wechatModel.go
└── wechatModel_gen.go
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>&lt;code>api&lt;/code> 文件夹用于存放外部调用，需要改动的是 &lt;code>*.api&lt;/code>, &lt;code>etc/*.yaml&lt;/code>, &lt;code>svc/serviceContext.go&lt;/code>, &lt;code>logic/*&lt;/code>，作用分别是生成 api 调用框架，写配置文件，将数据添加到 Context 供逻辑调用，逻辑实现。&lt;/li>
&lt;li>&lt;code>genModel&lt;/code> 文件夹用于生成数据库调用相关实现，需要改动的是&lt;code>resources/*.sql&lt;/code>。&lt;/li>
&lt;li>&lt;code>model&lt;/code> 文件夹用于添加额外的数据库调用逻辑（将&lt;code>genModel/model/*&lt;/code>复制到model后开改！）&lt;/li>
&lt;/ul>
&lt;h3 id="简单使用">简单使用&lt;/h3>
&lt;p>通过goctl生成代码框架。&lt;/p>
&lt;h4 id="api-框架通过-apiapi生成">API 框架通过 &lt;code>api/*.api&lt;/code>生成&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt"> 10
&lt;/span>&lt;span class="lnt"> 11
&lt;/span>&lt;span class="lnt"> 12
&lt;/span>&lt;span class="lnt"> 13
&lt;/span>&lt;span class="lnt"> 14
&lt;/span>&lt;span class="lnt"> 15
&lt;/span>&lt;span class="lnt"> 16
&lt;/span>&lt;span class="lnt"> 17
&lt;/span>&lt;span class="lnt"> 18
&lt;/span>&lt;span class="lnt"> 19
&lt;/span>&lt;span class="lnt"> 20
&lt;/span>&lt;span class="lnt"> 21
&lt;/span>&lt;span class="lnt"> 22
&lt;/span>&lt;span class="lnt"> 23
&lt;/span>&lt;span class="lnt"> 24
&lt;/span>&lt;span class="lnt"> 25
&lt;/span>&lt;span class="lnt"> 26
&lt;/span>&lt;span class="lnt"> 27
&lt;/span>&lt;span class="lnt"> 28
&lt;/span>&lt;span class="lnt"> 29
&lt;/span>&lt;span class="lnt"> 30
&lt;/span>&lt;span class="lnt"> 31
&lt;/span>&lt;span class="lnt"> 32
&lt;/span>&lt;span class="lnt"> 33
&lt;/span>&lt;span class="lnt"> 34
&lt;/span>&lt;span class="lnt"> 35
&lt;/span>&lt;span class="lnt"> 36
&lt;/span>&lt;span class="lnt"> 37
&lt;/span>&lt;span class="lnt"> 38
&lt;/span>&lt;span class="lnt"> 39
&lt;/span>&lt;span class="lnt"> 40
&lt;/span>&lt;span class="lnt"> 41
&lt;/span>&lt;span class="lnt"> 42
&lt;/span>&lt;span class="lnt"> 43
&lt;/span>&lt;span class="lnt"> 44
&lt;/span>&lt;span class="lnt"> 45
&lt;/span>&lt;span class="lnt"> 46
&lt;/span>&lt;span class="lnt"> 47
&lt;/span>&lt;span class="lnt"> 48
&lt;/span>&lt;span class="lnt"> 49
&lt;/span>&lt;span class="lnt"> 50
&lt;/span>&lt;span class="lnt"> 51
&lt;/span>&lt;span class="lnt"> 52
&lt;/span>&lt;span class="lnt"> 53
&lt;/span>&lt;span class="lnt"> 54
&lt;/span>&lt;span class="lnt"> 55
&lt;/span>&lt;span class="lnt"> 56
&lt;/span>&lt;span class="lnt"> 57
&lt;/span>&lt;span class="lnt"> 58
&lt;/span>&lt;span class="lnt"> 59
&lt;/span>&lt;span class="lnt"> 60
&lt;/span>&lt;span class="lnt"> 61
&lt;/span>&lt;span class="lnt"> 62
&lt;/span>&lt;span class="lnt"> 63
&lt;/span>&lt;span class="lnt"> 64
&lt;/span>&lt;span class="lnt"> 65
&lt;/span>&lt;span class="lnt"> 66
&lt;/span>&lt;span class="lnt"> 67
&lt;/span>&lt;span class="lnt"> 68
&lt;/span>&lt;span class="lnt"> 69
&lt;/span>&lt;span class="lnt"> 70
&lt;/span>&lt;span class="lnt"> 71
&lt;/span>&lt;span class="lnt"> 72
&lt;/span>&lt;span class="lnt"> 73
&lt;/span>&lt;span class="lnt"> 74
&lt;/span>&lt;span class="lnt"> 75
&lt;/span>&lt;span class="lnt"> 76
&lt;/span>&lt;span class="lnt"> 77
&lt;/span>&lt;span class="lnt"> 78
&lt;/span>&lt;span class="lnt"> 79
&lt;/span>&lt;span class="lnt"> 80
&lt;/span>&lt;span class="lnt"> 81
&lt;/span>&lt;span class="lnt"> 82
&lt;/span>&lt;span class="lnt"> 83
&lt;/span>&lt;span class="lnt"> 84
&lt;/span>&lt;span class="lnt"> 85
&lt;/span>&lt;span class="lnt"> 86
&lt;/span>&lt;span class="lnt"> 87
&lt;/span>&lt;span class="lnt"> 88
&lt;/span>&lt;span class="lnt"> 89
&lt;/span>&lt;span class="lnt"> 90
&lt;/span>&lt;span class="lnt"> 91
&lt;/span>&lt;span class="lnt"> 92
&lt;/span>&lt;span class="lnt"> 93
&lt;/span>&lt;span class="lnt"> 94
&lt;/span>&lt;span class="lnt"> 95
&lt;/span>&lt;span class="lnt"> 96
&lt;/span>&lt;span class="lnt"> 97
&lt;/span>&lt;span class="lnt"> 98
&lt;/span>&lt;span class="lnt"> 99
&lt;/span>&lt;span class="lnt">100
&lt;/span>&lt;span class="lnt">101
&lt;/span>&lt;span class="lnt">102
&lt;/span>&lt;span class="lnt">103
&lt;/span>&lt;span class="lnt">104
&lt;/span>&lt;span class="lnt">105
&lt;/span>&lt;span class="lnt">106
&lt;/span>&lt;span class="lnt">107
&lt;/span>&lt;span class="lnt">108
&lt;/span>&lt;span class="lnt">109
&lt;/span>&lt;span class="lnt">110
&lt;/span>&lt;span class="lnt">111
&lt;/span>&lt;span class="lnt">112
&lt;/span>&lt;span class="lnt">113
&lt;/span>&lt;span class="lnt">114
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-go" data-lang="go">&lt;span class="c1">//park.api
&lt;/span>&lt;span class="c1">&lt;/span>&lt;span class="nx">syntax&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s">&amp;#34;v1&amp;#34;&lt;/span>
&lt;span class="nf">info&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">title&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;parkApi&amp;#34;&lt;/span>
&lt;span class="nx">desc&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;parkBackEnd&amp;#34;&lt;/span>
&lt;span class="nx">author&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;loomt&amp;#34;&lt;/span>
&lt;span class="nx">email&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;loomt_@outlook.com&amp;#34;&lt;/span>
&lt;span class="nx">version&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s">&amp;#34;1.0&amp;#34;&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="kd">type&lt;/span> &lt;span class="p">(&lt;/span>
&lt;span class="nx">accessResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">Location&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;location&amp;#34;`&lt;/span> &lt;span class="c1">// 接入地点
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Date&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;date&amp;#34;`&lt;/span> &lt;span class="c1">// 接入日期
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Num&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;num&amp;#34;`&lt;/span> &lt;span class="c1">// 接入数量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">incomeResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">Type&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;type&amp;#34;`&lt;/span> &lt;span class="c1">// 收入类型
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Date&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;date&amp;#34;`&lt;/span> &lt;span class="c1">// 日期
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Num&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;num&amp;#34;`&lt;/span> &lt;span class="c1">// 当天收入
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">parkingLotResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">Name&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;name&amp;#34;`&lt;/span> &lt;span class="c1">// 停车场名字
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Duration&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;duration&amp;#34;`&lt;/span> &lt;span class="c1">// 停车时间（小时）
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Num&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;num&amp;#34;`&lt;/span> &lt;span class="c1">// 泊车数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">siteInfoResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">Date&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;date&amp;#34;`&lt;/span> &lt;span class="c1">// 日期
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">RevisitRate&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;revisit_rate&amp;#34;`&lt;/span> &lt;span class="c1">// 重复访问率（%）
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">SiteHealth&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;site_health&amp;#34;`&lt;/span> &lt;span class="c1">// 站点健康度
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">RfHealth&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;rf_health&amp;#34;`&lt;/span> &lt;span class="c1">// 射频健康度
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">DeviceHealth&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;device_health&amp;#34;`&lt;/span> &lt;span class="c1">// 设备健康度
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Flow&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;flow&amp;#34;`&lt;/span> &lt;span class="c1">// 当日站点流量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">touristFlowResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">Location&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;location&amp;#34;`&lt;/span> &lt;span class="c1">// 园区地点
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Date&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;date&amp;#34;`&lt;/span> &lt;span class="c1">// 时间
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Num&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;num&amp;#34;`&lt;/span> &lt;span class="c1">// 游客数量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">touristCarProvinceResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">Province&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;province&amp;#34;`&lt;/span> &lt;span class="c1">// 省份
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Date&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;date&amp;#34;`&lt;/span> &lt;span class="c1">// 日期
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">FlowNum&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;flow_num&amp;#34;`&lt;/span> &lt;span class="c1">// 人流数量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">CarNum&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;car_num&amp;#34;`&lt;/span> &lt;span class="c1">// 车辆数
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">userReq&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span> &lt;span class="c1">// 用户id
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">userResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span> &lt;span class="c1">// 用户id
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Username&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;username&amp;#34;`&lt;/span> &lt;span class="c1">// 用户名
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">wechatResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Date&lt;/span> &lt;span class="kt">string&lt;/span> &lt;span class="s">`json:&amp;#34;date&amp;#34;`&lt;/span> &lt;span class="c1">// 日期
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Num&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;num&amp;#34;`&lt;/span> &lt;span class="c1">// 微信关注数量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="nx">deviceInfoResp&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">Id&lt;/span> &lt;span class="kt">int64&lt;/span> &lt;span class="s">`json:&amp;#34;id&amp;#34;`&lt;/span>
&lt;span class="nx">UplinkRate&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;uplink_rate&amp;#34;`&lt;/span> &lt;span class="c1">// 上行速率
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">DownlinkRate&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;downlink_rate&amp;#34;`&lt;/span> &lt;span class="c1">// 下载速率
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Flow&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;flow&amp;#34;`&lt;/span> &lt;span class="c1">// 流量
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">CpuRate&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;cpu_rate&amp;#34;`&lt;/span> &lt;span class="c1">// CPU占有率
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Longitude&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;longitude&amp;#34;`&lt;/span> &lt;span class="c1">// 经度
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="nx">Latitude&lt;/span> &lt;span class="kt">float64&lt;/span> &lt;span class="s">`json:&amp;#34;latitude&amp;#34;`&lt;/span> &lt;span class="c1">// 纬度
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="p">}&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nf">server&lt;/span>&lt;span class="p">(&lt;/span>
&lt;span class="nx">prefix&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="nx">api&lt;/span>
&lt;span class="p">)&lt;/span>
&lt;span class="nx">service&lt;/span> &lt;span class="nx">park&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="nx">api&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取接入详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">accessHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">access&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">accessResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取日收入详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">incomeHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">income&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">incomeResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取停车详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">parkingLotHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">parkingLot&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">parkingLotResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取站点详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">siteInfoHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">siteInfo&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">siteInfoResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取客流量详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">touristFlowHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">touristFlow&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">touristFlowResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取游客与车辆来源省份&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">touristCarProvinceHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">touristCarProvince&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">touristCarProvinceResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取用户详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">userHandler&lt;/span>
&lt;span class="nx">post&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nf">user&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">userReq&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">userResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取微信关注详情&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">wechatHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">wechat&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">wechatResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">doc&lt;/span> &lt;span class="s">&amp;#34;获取设备信息&amp;#34;&lt;/span>
&lt;span class="err">@&lt;/span>&lt;span class="nx">handler&lt;/span> &lt;span class="nx">deviceInfoHandler&lt;/span>
&lt;span class="nx">get&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="nx">deviceInfo&lt;/span> &lt;span class="nf">returns&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">deviceInfoResp&lt;/span>&lt;span class="p">)&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="c1"># api&lt;/span>
goctl api go -api *.api -dir ./ --style&lt;span class="o">=&lt;/span>goZero
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="model-框架有两种生成方式">MODEL 框架有两种生成方式&lt;/h4>
&lt;ul>
&lt;li>连接数据库生成model&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-zsh" data-lang="zsh">&lt;span class="cp">#!/usr/bin/env zsh
&lt;/span>&lt;span class="cp">&lt;/span>&lt;span class="c1"># 使用方法：&lt;/span>
&lt;span class="c1"># ./genModel.sh usercenter user&lt;/span>
&lt;span class="c1"># ./genModel.sh usercenter user_auth&lt;/span>
&lt;span class="c1"># 再将./genModel下的文件剪切到对应服务的model目录里面，记得改package&lt;/span>
&lt;span class="c1">#生成的表名&lt;/span>
&lt;span class="nv">tables&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$2&lt;/span>
&lt;span class="c1">#表生成的genmodel目录&lt;/span>
&lt;span class="nv">modeldir&lt;/span>&lt;span class="o">=&lt;/span>../model
&lt;span class="c1"># 数据库配置&lt;/span>
&lt;span class="nv">host&lt;/span>&lt;span class="o">=&lt;/span>127.0.0.1
&lt;span class="nv">port&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">3306&lt;/span>
&lt;span class="nv">dbname&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="nv">$1&lt;/span>
&lt;span class="nv">username&lt;/span>&lt;span class="o">=&lt;/span>root
&lt;span class="nv">passwd&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="m">123456&lt;/span>
&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;开始创建库：&lt;/span>&lt;span class="nv">$dbname&lt;/span>&lt;span class="s2"> 的表：&lt;/span>&lt;span class="nv">$2&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>
goctl model mysql datasource -url&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">username&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">passwd&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">@tcp(&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">host&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">:&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">port&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">)/&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">dbname&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -table&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">tables&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> -dir&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span>&lt;span class="si">${&lt;/span>&lt;span class="nv">modeldir&lt;/span>&lt;span class="si">}&lt;/span>&lt;span class="s2">&amp;#34;&lt;/span> --style&lt;span class="o">=&lt;/span>goZero
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ul>
&lt;li>直接用 sql 文件(&lt;code>genModel/resource/*.sql&lt;/code>)生成 model&lt;/li>
&lt;/ul>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-zsh" data-lang="zsh">&lt;span class="c1"># genModel/resources&lt;/span>
goctl model mysql ddl -src&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;./*.sql&amp;#34;&lt;/span> -dir&lt;span class="o">=&lt;/span>&lt;span class="s2">&amp;#34;../model&amp;#34;&lt;/span> --style&lt;span class="o">=&lt;/span>goZero
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h4 id="生成文档">生成文档&lt;/h4>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-zsh" data-lang="zsh">&lt;span class="c1"># ./&lt;/span>
goctl api doc -dir .
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h2 id="华为云部署">华为云部署&lt;/h2>
&lt;ol>
&lt;li>mysql 导入&lt;/li>
&lt;li>&lt;code>nohup go run *.go -f etc/*.yaml 2&amp;gt;&amp;amp;1 &amp;amp;&lt;/code>&lt;/li>
&lt;/ol></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/></entry><entry><title type="text">华为云公网部署</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2/"/><id>https://loomt.top/posts/%E5%8D%8E%E4%B8%BA%E4%BA%91%E5%85%AC%E7%BD%91%E9%83%A8%E7%BD%B2/</id><updated>2023-02-08T14:45:05+00:00</updated><published>2022-11-08T22:47:51+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">记一次华为云耀云服务器公网部署问题 开了安全组，用 caddy 部署了一个小网页来测试公网访问 可以看到内网访问是正常的。也可以 ping 通 根据华为云官网给出的指引排查了很久，绑定了弹…</summary><content type="html">&lt;h2 id="记一次华为云耀云服务器公网部署问题">记一次华为云耀云服务器公网部署问题&lt;/h2>
&lt;p>开了安全组，用 caddy 部署了一个小网页来测试公网访问
&lt;img src="https://loomt.top/img/sky.jpg" alt="sky">&lt;/p>
&lt;p>&lt;img src="https://loomt.top/img/caddy.png" alt="run-caddy">&lt;/p>
&lt;p>可以看到内网访问是正常的。也可以 ping 通&lt;/p>
&lt;p>&lt;img src="https://loomt.top/img/ping-cloud.png" alt="ping-cloud">&lt;/p>
&lt;p>根据华为云官网给出的指引排查了很久，绑定了弹性公网 ip，设置了安全组 Sys-FullAccess、ACL，都无法用浏览器访问。&lt;/p>
&lt;p>最后回到服务器 &lt;em>查询防火墙状态&lt;/em>&lt;/p>
&lt;p>关掉防火墙就可以了
&lt;img src="https://loomt.top/img/disable-firewall.png" alt="disable-firewall">
对着华为云的控制台搞了很久安全组，还以为安全组哪里配错了，最后发现是服务器防火墙的问题😭&lt;/p></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/></entry><entry><title type="text">小米4A千兆版刷OpenWrt</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/%E5%B0%8F%E7%B1%B34a%E5%8D%83%E5%85%86%E7%89%88%E5%88%B7openwrt/"/><id>https://loomt.top/posts/%E5%B0%8F%E7%B1%B34a%E5%8D%83%E5%85%86%E7%89%88%E5%88%B7openwrt/</id><updated>2023-02-08T14:45:05+00:00</updated><published>2022-08-12T15:58:38+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">摆烂，于是将目光看向了家里的小米4a千兆版路由器，准备刷个Openwrt玩一下。 去恩山论坛逛了逛，感觉刷软路由和刷手机差不太多。 安装Breed（闭源免费的Boo…</summary><content type="html">&lt;blockquote>
&lt;p>摆烂，于是将目光看向了家里的小米4a千兆版路由器，准备刷个Openwrt玩一下。&lt;/p>
&lt;/blockquote>
&lt;p>去&lt;a href="https://www.right.com.cn/forum/forum.php">恩山论坛&lt;/a>逛了逛，感觉刷软路由和刷手机差不太多。&lt;/p>
&lt;ol>
&lt;li>安装Breed（闭源免费的BootLoader，又称“不死鸟”，有了它就能肆无忌惮地刷各种第三方包了&lt;/li>
&lt;/ol>
&lt;p>如果你的路由器是小米4A千兆版，可以直接用恩山论坛的&lt;a href="https://pan.loomt.top/Xiaomi4A/R4A.zip">无脑直装Breed&lt;/a>；如果不是，也可以去&lt;a href="https://breed.hackpascal.net/">Breed官网&lt;/a>下载路由器的适配包并自行搜索如何通过Telnet连接路由器并刷入Breed。
&lt;img src="https://loomt.top/img/breed.png" alt="Breed">&lt;/p>
&lt;ol start="2">
&lt;li>用Breed安装OpenWrt&lt;/li>
&lt;/ol>
&lt;p>这里放一个&lt;a href="https://pan.loomt.top/Xiaomi4A/openwrt-ramips-mt7621-xiaomi_mi-router-4a-gigabit-squashfs-sysupgrade.bin">小米4A千兆版OpenWrt直刷包&lt;/a>，其他路由器的固件可以去恩山论坛逛逛。
&lt;style type="text/css">.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media (prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}&lt;/style>
&lt;div>&lt;svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg">&lt;symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/>&lt;/symbol>&lt;symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>&lt;/symbol>&lt;symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>&lt;/symbol>&lt;symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/>&lt;/symbol>&lt;/svg>&lt;/div>&lt;div class="notice warning" >
&lt;p class="first notice-title">&lt;span class="icon-notice baseline">&lt;svg>&lt;use href="https://loomt.top/posts/%E5%B0%8F%E7%B1%B34a%E5%8D%83%E5%85%86%E7%89%88%E5%88%B7openwrt/#warning-notice">&lt;/use>&lt;/svg>&lt;/span>警告&lt;/p>&lt;p>刷OpenWrt之前必须用Breed备份eeprom（没有备份eeprom将导致5G信号奇差）&lt;/p>&lt;/div>
&lt;/p>
&lt;p>点击固件更新~&amp;gt;常规固件~&amp;gt;勾上“固件”和“EEPROM”，选择好上面的直刷包和备份的eeprom.bin，上传即可。&lt;/p>
&lt;ol start="3">
&lt;li>配置OpenWrt的各项参数（随便配一下即可&lt;/li>
&lt;/ol>
&lt;p>OpenWrt可谓神通广大，作为一个在路由器上跑的Linux，它可以装上各种插件：酸酸乳、Docker、网易云解锁灰色歌曲……&lt;/p>
&lt;p>但我折腾了一通，调教好基础的上网功能后，感觉网络状况大不如前。作为百来块的路由器，本来就没有多大的内存，感觉原厂固件的调教已经将性能都用在刀刃上了。装了OpenWrt后虽然上下行流量速度没有很大变化，但稳定性差了很多，便懒得继续折腾，忍痛remake了。&lt;/p>
&lt;ol start="4">
&lt;li>刷回官方包（没备份eeprom的问题 &lt;strong>或许&lt;/strong> 也可以通过刷回官方包的方法解决&lt;/li>
&lt;/ol>
&lt;p>下载&lt;a href="https://pan.loomt.top/Xiaomi4A/all.bin">小米4A千兆版官方包&lt;/a>，进入Breed~&amp;gt;固件更新~&amp;gt;编程器固件(仅勾选自动重启)~&amp;gt;上传all.bin。&lt;/p></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/></entry><entry><title type="text">建站</title><link rel="alternate" type="text/html" href="https://loomt.top/posts/%E5%BB%BA%E7%AB%99/"/><id>https://loomt.top/posts/%E5%BB%BA%E7%AB%99/</id><updated>2023-02-08T14:45:05+00:00</updated><published>2022-07-15T12:01:10+08:00</published><author><name>loomt</name><uri>https://loomt.top</uri><email>loomt_@outlook.com</email></author><rights>[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)</rights><summary type="html">前段时间白嫖了一个 域名 ，暑假有时间了赶紧物尽其用，于是花了一天的时间重新建了个站（其实我很久之前就用过 hexo 无脑建站，但最近发现了一个特别喜欢的Hugo主题 MemE ） 简略…</summary><content type="html">&lt;p>&lt;img src="https://loomt.top/img/sky.jpg" alt="sky">&lt;/p>
&lt;blockquote>
&lt;p>前段时间白嫖了一个 &lt;a href="https://loomt.eu.org">域名&lt;/a> ，暑假有时间了赶紧物尽其用，于是花了一天的时间重新建了个站（其实我很久之前就用过 hexo 无脑建站，但最近发现了一个特别喜欢的&lt;a href="https://gohugo.io/">Hugo&lt;/a>主题 &lt;a href="https://github.com/reuixiy/hugo-theme-meme">MemE&lt;/a> ）&lt;/p>
&lt;/blockquote>
&lt;h1 id="简略步骤">简略步骤&lt;/h1>
&lt;h2 id="hugo-quick-start">Hugo Quick Start&lt;/h2>
&lt;ol>
&lt;li>在 wsl 下装 Hugo&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ sudo apt install hugo
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="2">
&lt;li>TL;DR 一下 Hugo 的基础命令&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ tldr hugo
hugo
Template-based static site generator. Uses modules, components, and themes.More information: https://gohugo.io.
- Create a new Hugo site:
hugo new site &lt;span class="o">{{&lt;/span>path/to/site&lt;span class="o">}}&lt;/span>
- Create a new Hugo theme &lt;span class="o">(&lt;/span>themes may also be downloaded from https://themes.gohugo.io/&lt;span class="o">)&lt;/span>:
hugo new theme &lt;span class="o">{{&lt;/span>theme_name&lt;span class="o">}}&lt;/span>
- Create a new page:
hugo new &lt;span class="o">{{&lt;/span>section_name&lt;span class="o">}}&lt;/span>/&lt;span class="o">{{&lt;/span>filename&lt;span class="o">}}&lt;/span>
- Build a site to the ./public/ directory:
hugo
- Build a site including pages that are marked as a &lt;span class="s2">&amp;#34;draft&amp;#34;&lt;/span>:
hugo --buildDrafts
- Build a site to a given directory:
hugo --destination &lt;span class="o">{{&lt;/span>path/to/destination&lt;span class="o">}}&lt;/span>
- Build a site, start up a webserver to serve it, and automatically reload when pages are edited:
hugo server
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>新建站点&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ hugo new site loomt
Congratulations! Your new Hugo site is created in /home/loomt/temp/loomt.
Just a few more steps and you are ready to go:
1. Download a theme into the same-named folder.
 Choose a theme from https://themes.gohugo.io/ or
 create your own with the &lt;span class="s2">&amp;#34;hugo new theme &amp;lt;THEMENAME&amp;gt;&amp;#34;&lt;/span> command.
2. Perhaps you want to add some content. You can add single files
 with &lt;span class="s2">&amp;#34;hugo new &amp;lt;SECTIONNAME&amp;gt;/&amp;lt;FILENAME&amp;gt;.&amp;lt;FORMAT&amp;gt;&amp;#34;&lt;/span>.
3. Start the built-in live server via &lt;span class="s2">&amp;#34;hugo server&amp;#34;&lt;/span>.
Visit https://gohugo.io/ &lt;span class="k">for&lt;/span> quickstart guide and full documentation.
$ &lt;span class="nb">cd&lt;/span> loomt
$ tree
.
├── archetypes
│   └── default.md
├── config.toml
├── content
├── data
├── layouts
├── static
└── themes
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="4">
&lt;li>配置主题&lt;/li>
&lt;/ol>
&lt;pre tabindex="0">&lt;code>$ git init
# 将皮肤作为submodule添加，以便更新
$ git submodule add https://github.com/reuixiy/hugo-theme-meme.git themes/meme # MeME，很喜欢的一个主题
$ git submodule add https://github.com/martignoni/hugo-notice.git themes/hugo-notice # hugo-notice，插件主题（很轻，开箱即用）
$ rm config.toml &amp;amp;&amp;amp; cp themes/meme/config-examples/zh-cn/config.toml config.toml #覆盖配置文件
&lt;/code>&lt;/pre>&lt;ol start="5">
&lt;li>发布文章&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ hugo new posts/HelloWorld.md &lt;span class="c1">#会在centent下面创建markdown文件，可以直接去编辑&lt;/span>
Content &lt;span class="s2">&amp;#34;/home/loomt/temp/loomt/content/posts/HelloWorld.md&amp;#34;&lt;/span> created
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="6">
&lt;li>运行本地服务&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ hugo server -D --verbose &lt;span class="c1"># 在本地运行 -D是渲染草稿 --verbose显示详细输出&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>目前已经完成基本配置，可以访问运行在本机的站点了 🥳&lt;/p>
&lt;p>接下来还可以将网站部署到 Github Page，Vercel 或者 Netlify 等免费的静态资源托管商。&lt;/p>
&lt;h2 id="hugo-部署到-github-page">Hugo 部署到 Github Page&lt;/h2>
&lt;p>Hugo 是一个网站构建工具，&lt;code>hugo&lt;/code>命令生成的 public 文件夹存放的是静态的部署页面，我们只需要将其放在 Github Page 中即可。建议开两个仓库，一个仓库用于存放根目录，另一个用于存放./public 文件夹的内容，以便被 Github Page 部署。&lt;/p>
&lt;blockquote>
&lt;p>因为根目录可能有敏感信息和暂时不希望公开的草稿，又为了让其得到有效的版本控制，可以开一个私有仓库存放根目录，&lt;/p>
&lt;p>而 publishDir(./pubic) 作为输出的静态页面，则适合放在公开的仓库 &lt;del>而且 Github Page 不公开没法白嫖&lt;/del>&lt;/p>
&lt;/blockquote>
&lt;p>默认看到这里的同学已经建好了仓库，并完成了仓库的初始化和配置 🤗&lt;/p>
&lt;p>下面假设更新了文章，需要同步到两个仓库。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ hugo --gc --cleanDestinationDir &lt;span class="c1"># 生成静态站点到./public的同时 清除缓存和静态站点用不着的文件&lt;/span>
$ git add .
$ git commit -m &lt;span class="s2">&amp;#34;update source code&amp;#34;&lt;/span>
$ git push
$ &lt;span class="nb">cd&lt;/span> public
$ git add .
$ git commit -m &lt;span class="s2">&amp;#34;update Github Page&amp;#34;&lt;/span>
$ git push
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>是不是感觉要 push 两次非常麻烦，可以写一个 push.sh 来简化操作，还可以加个 Github Actions，简化每次更新站点的步骤，具体可阅读 &lt;a href="https://docs.github.com/cn/actions/learn-github-actions/understanding-github-actions">GitHub Actions 官方文档&lt;/a>，&lt;a href="https://github.com/peaceiris/actions-gh-pages">actions-gh-pages&lt;/a> 以及 &lt;a href="https://io-oi.me/tech/deploy-hugo-to-github-pages-via-github-actions/">reuixiy 的博客&lt;/a> 。&lt;/p>
&lt;h3 id="自动化部署">自动化部署&lt;/h3>
&lt;ul>
&lt;li>
&lt;p>如果源码仓库和 Github Page 仓库都是公有的话可以阅读 &lt;a href="https://github.com/peaceiris/actions-gh-pages">actions-gh-pages&lt;/a> 进行简单的配置。&lt;/p>
&lt;/li>
&lt;li>
&lt;p>如果源码仓库是私有的，Github Page 仓库是公开的话，可以参考以下配置方案。&lt;/p>
&lt;/li>
&lt;/ul>
&lt;ol>
&lt;li>配置公钥和私钥到仓库&lt;/li>
&lt;/ol>
&lt;p>需要生成 SSH key pair 以获取源码仓库对 Github Page 仓库修改的权限。&lt;/p>
&lt;pre tabindex="0">&lt;code>$ mkdir -p ~/.ssh/blog
$ cd ~/.ssh/blog
$ ssh-keygen -t rsa -b 4096 -C &amp;quot;yourname@users.noreply.github.com&amp;quot;
# 注意：不要无脑回车，最好开一个文件夹存公钥私钥，不然会覆盖掉以前的
&lt;/code>&lt;/pre>&lt;ul>
&lt;li>id_rsa（私钥）&lt;/li>
&lt;/ul>
&lt;p>前往 Github Page 仓库，Settings &amp;gt; Deploy Keys &amp;gt; Add deploy key。&lt;/p>
&lt;p>需要勾选 Allow write access。&lt;/p>
&lt;ul>
&lt;li>id_rsa.pub （公钥）&lt;/li>
&lt;/ul>
&lt;p>前往源码仓库，Settings &amp;gt; Secrets &amp;gt; Actions &amp;gt; New repository secret。&lt;/p>
&lt;p>Name 需要设为 ACTIONS_DEPLOY_KEY&lt;/p>
&lt;ol start="2">
&lt;li>新建 Workflow 配置文件&lt;/li>
&lt;/ol>
&lt;p>下面粘一下我的配置方案&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="c"># .github/workflows/build.yml&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Hugo automated deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">push&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">branches&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>- &lt;span class="l">main  # Set a branch name to trigger deployment&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">jobs&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">deploy&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">runs-on&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">ubuntu-latest&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">permissions&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="nt">contents&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">write&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">concurrency&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="nt">group&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ github.workflow }}-${{ github.ref }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">steps&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>- &lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">actions/checkout@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">      &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">submodules&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="c"># Fetch Hugo themes (true OR recursive)&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">fetch-depth&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c"># Fetch all history for .GitInfo and .Lastmod&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Setup Hugo&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">      &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-hugo@v2&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">      &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">hugo-version&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s1">&amp;#39;0.92.2&amp;#39;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">extended&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Build&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">      &lt;/span>&lt;span class="nt">run&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">hugo --gc --minify&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c"># - name: Deploy&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#   uses: peaceiris/actions-gh-pages@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#   # If you&amp;#39;re changing the branch from main,&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#   # also change the `main` in `refs/heads/main`&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#   # below accordingly.&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#   if: ${{ github.ref == &amp;#39;refs/heads/main&amp;#39; }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#   with:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#     github_token: ${{ secrets.GITHUB_TOKEN }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>&lt;span class="c">#     publish_dir: ./public&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">    &lt;/span>- &lt;span class="nt">name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">Deploy  # 此处需要按照自己实际修改&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">      &lt;/span>&lt;span class="nt">uses&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">peaceiris/actions-gh-pages@v3&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">      &lt;/span>&lt;span class="nt">with&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">deploy_key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">${{ secrets.ACTIONS_DEPLOY_KEY }}&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">external_repository&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">loomts/loomts.github.io&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">publish_branch: main  # default&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">gh-pages&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">        &lt;/span>&lt;span class="nt">publish_dir&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">./public&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;ol start="3">
&lt;li>推送到 Github&lt;/li>
&lt;/ol>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ git add .
$ git commit -m &lt;span class="s2">&amp;#34;setup auto deploy&amp;#34;&lt;/span>
$ git push
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>打开你的源码仓库页面，点击 Actions 查看日志，顺利的话已经搞定了，以后每次 &lt;code>git push&lt;/code> Github Workflow 都会自动帮你更新网站了。&lt;/p>
&lt;h2 id="github-page-绑定自定义域名">Github Page 绑定自定义域名&lt;/h2>
&lt;p>假设已经有了域名，还需要在域名的 DNS 服务商那里加一个 CNAME （用于 dns 跳转）。&lt;/p>
&lt;table>
&lt;thead>
&lt;tr>
&lt;th>name&lt;/th>
&lt;th>type&lt;/th>
&lt;th>value&lt;/th>
&lt;/tr>
&lt;/thead>
&lt;tbody>
&lt;tr>
&lt;td>www&lt;/td>
&lt;td>CNAME&lt;/td>
&lt;td>loomts.github.io&lt;/td>
&lt;/tr>
&lt;/tbody>
&lt;/table>
&lt;p>一段时间后，回到 Github Page 仓库，在 Settings &amp;gt; Pages &amp;gt; Custom domain 处填上自己的域名，等待几小时生成证书，然后勾选  &lt;code>Enforce HTTPS&lt;/code>。&lt;/p>
&lt;p>还要记得添加 &lt;code>your domain&lt;/code> 到 static/CNAME ，以生成到静态文件。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ &lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;your domain&amp;#34;&lt;/span> &amp;gt; static/CNAME
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>Custom domains are stored in a &lt;em>CNAME&lt;/em> file in the root of your publishing source. You can add or update this file through your repository settings or manually. For more information, see &amp;quot; &lt;a href="https://docs.github.com/en/articles/managing-a-custom-domain-for-your-github-pages-site">Managing a custom domain for your GitHub Pages site&lt;/a> .&amp;quot; ——Github Docs&lt;/p>
&lt;/blockquote>
&lt;h2 id="hugo-部署到-vercel">Hugo 部署到 Vercel&lt;/h2>
&lt;p>&lt;a href="https://vercel.com">Vercel&lt;/a> 可以看作是结合了 Github Page 还有 Github Actions 的用于前端框架和静态站点管的平台，直接导入 Github 仓库即可部署，感觉配置起来比 Github Action 无脑很多，很适合我，所以我已经放弃 Github Action，全面转为 Vercel 了。需要注意的是注册域名的时候要去域名注册商改一下 DNS 服务器，或者每个站点都添加一次 A 记录。&lt;/p>
&lt;h2 id="hugo-个性化配置">Hugo 个性化配置&lt;/h2>
&lt;h3 id="皮肤配置">皮肤配置&lt;/h3>
&lt;p>可以根据皮肤作者的文档改变皮肤的各种 feature，如 MeME 的 config.toml &lt;a href="https://github.com/reuixiy/hugo-theme-meme/blob/master/config-examples/zh-cn/config.toml">example&lt;/a>&lt;/p>
&lt;style type="text/css">.notice{--root-color:#444;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#c33;--warning-content:#fee;--info-title:#fb7;--info-content:#fec;--note-title:#6be;--note-content:#e7f2fa;--tip-title:#5a5;--tip-content:#efe}@media (prefers-color-scheme:dark){.notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}}body.dark .notice{--root-color:#ddd;--root-background:#eff;--title-color:#fff;--title-background:#7bd;--warning-title:#800;--warning-content:#400;--info-title:#a50;--info-content:#420;--note-title:#069;--note-content:#023;--tip-title:#363;--tip-content:#121}.notice{padding:18px;line-height:24px;margin-bottom:24px;border-radius:4px;color:var(--root-color);background:var(--root-background)}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:var(--title-color);background:var(--title-background)}.notice.warning .notice-title{background:var(--warning-title)}.notice.warning{background:var(--warning-content)}.notice.info .notice-title{background:var(--info-title)}.notice.info{background:var(--info-content)}.notice.note .notice-title{background:var(--note-title)}.notice.note{background:var(--note-content)}.notice.tip .notice-title{background:var(--tip-title)}.notice.tip{background:var(--tip-content)}.icon-notice{display:inline-flex;align-self:center;margin-right:8px}.icon-notice img,.icon-notice svg{height:1em;width:1em;fill:currentColor}.icon-notice img,.icon-notice.baseline svg{top:.125em;position:relative}&lt;/style>
&lt;div>&lt;svg width="0" height="0" display="none" xmlns="http://www.w3.org/2000/svg">&lt;symbol id="tip-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M504 256c0 136.967-111.033 248-248 248S8 392.967 8 256 119.033 8 256 8s248 111.033 248 248zM227.314 387.314l184-184c6.248-6.248 6.248-16.379 0-22.627l-22.627-22.627c-6.248-6.249-16.379-6.249-22.628 0L216 308.118l-70.059-70.059c-6.248-6.248-16.379-6.248-22.628 0l-22.627 22.627c-6.248 6.248-6.248 16.379 0 22.627l104 104c6.249 6.249 16.379 6.249 22.628.001z"/>&lt;/symbol>&lt;symbol id="note-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M504 256c0 136.997-111.043 248-248 248S8 392.997 8 256C8 119.083 119.043 8 256 8s248 111.083 248 248zm-248 50c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>&lt;/symbol>&lt;symbol id="warning-notice" viewBox="0 0 576 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M569.517 440.013C587.975 472.007 564.806 512 527.94 512H48.054c-36.937 0-59.999-40.055-41.577-71.987L246.423 23.985c18.467-32.009 64.72-31.951 83.154 0l239.94 416.028zM288 354c-25.405 0-46 20.595-46 46s20.595 46 46 46 46-20.595 46-46-20.595-46-46-46zm-43.673-165.346l7.418 136c.347 6.364 5.609 11.346 11.982 11.346h48.546c6.373 0 11.635-4.982 11.982-11.346l7.418-136c.375-6.874-5.098-12.654-11.982-12.654h-63.383c-6.884 0-12.356 5.78-11.981 12.654z"/>&lt;/symbol>&lt;symbol id="info-notice" viewBox="0 0 512 512" preserveAspectRatio="xMidYMid meet">&lt;path d="M256 8C119.043 8 8 119.083 8 256c0 136.997 111.043 248 248 248s248-111.003 248-248C504 119.083 392.957 8 256 8zm0 110c23.196 0 42 18.804 42 42s-18.804 42-42 42-42-18.804-42-42 18.804-42 42-42zm56 254c0 6.627-5.373 12-12 12h-88c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h12v-64h-12c-6.627 0-12-5.373-12-12v-24c0-6.627 5.373-12 12-12h64c6.627 0 12 5.373 12 12v100h12c6.627 0 12 5.373 12 12v24z"/>&lt;/symbol>&lt;/svg>&lt;/div>&lt;div class="notice tip" >
&lt;p class="first notice-title">&lt;span class="icon-notice baseline">&lt;svg>&lt;use href="https://loomt.top/posts/%E5%BB%BA%E7%AB%99/#tip-notice">&lt;/use>&lt;/svg>&lt;/span>提示&lt;/p>&lt;p>config.toml 的 baseURL 要加 &lt;code>https://&lt;/code> ，否则生成的静态页面 css 和 js 加载会出问题。&lt;/p>&lt;/div>
&lt;h3 id="自定义-css-和-js">自定义 CSS 和 JS&lt;/h3>
&lt;ol>
&lt;li>利用 hugo 的&lt;a href="https://gohugo.io/templates/lookup-order/#hugo-layouts-lookup-rules-with-theme">替换规则&lt;/a>&lt;/li>
&lt;/ol>
&lt;p>当你需要更改某个页面的生成规则（包括 CSS 和 JS），你可以将 themes/your-theme 里面的东西复制一份到你的根目录，然后爽改逻辑，hugo 生成静态页面时在同等情况下会优先用你根目录下的文件。&lt;/p>
&lt;ol start="2">
&lt;li>如果你想要自己新建一个 js 或者 css 文件，可以看&lt;a href="https://gohugo.io/hugo-pipes">hugo-pipes&lt;/a>，但如果你不打算做一个开源主题，无脑在 html 文件里面堆 style 和 script 是能跑的选择！&lt;/li>
&lt;/ol>
&lt;p>比如，我有这样一个需求：在 Wiki 页面分层次显示我的笔记，但又不让笔记内容在主页面显示，并且 Wiki 页需要按照文件夹的内部结构展示，那就用&lt;a href="https://gohugo.io/content-management/taxonomies/#default-taxonomies">categories&lt;/a>的方式组织 content/wiki 的内容，仅需要改一下 MeME 主题 tree-sections 的内容，并配置一下 config.toml 即可。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;span class="lnt">71
&lt;/span>&lt;span class="lnt">72
&lt;/span>&lt;span class="lnt">73
&lt;/span>&lt;span class="lnt">74
&lt;/span>&lt;span class="lnt">75
&lt;/span>&lt;span class="lnt">76
&lt;/span>&lt;span class="lnt">77
&lt;/span>&lt;span class="lnt">78
&lt;/span>&lt;span class="lnt">79
&lt;/span>&lt;span class="lnt">80
&lt;/span>&lt;span class="lnt">81
&lt;/span>&lt;span class="lnt">82
&lt;/span>&lt;span class="lnt">83
&lt;/span>&lt;span class="lnt">84
&lt;/span>&lt;span class="lnt">85
&lt;/span>&lt;span class="lnt">86
&lt;/span>&lt;span class="lnt">87
&lt;/span>&lt;span class="lnt">88
&lt;/span>&lt;span class="lnt">89
&lt;/span>&lt;span class="lnt">90
&lt;/span>&lt;span class="lnt">91
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-html" data-lang="html">&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">main&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;main list&amp;#34;&lt;/span> &lt;span class="na">id&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;main&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;main-inner&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;content categories&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ if .Site.Params.displayListTitle }}
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">h1&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;list-title&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ &amp;#34;Wiki&amp;#34;}}
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">h1&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
存点笔记，仅作参考😶‍🌫️
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ end }}
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;tree&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">ul&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;list-categories&amp;#34;&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;display: block;&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ partial &amp;#34;utils/tree-sections.html&amp;#34; . }}
{{ $sections := .Scratch.Get &amp;#34;sections&amp;#34; }}
{{ $pages := .Scratch.Get &amp;#34;pages&amp;#34; }}
{{ range $index, $page := $pages }}
{{ $depth := (len (split (strings.TrimPrefix &amp;#34;/&amp;#34; $page) &amp;#34;/&amp;#34;)) }}
{{ with $.Site.GetPage $page }}
{{ $linkTarget := .}}
{{ $depthPrev := 0 }}
{{ if ge $index 1 }}
{{ $pagePrev := index $pages (sub $index 1) }}
{{ $depthPrev = len (split (strings.TrimPrefix &amp;#34;/&amp;#34; $pagePrev) &amp;#34;/&amp;#34;) }}
{{ end }}
{{ $depthNext := 0 }}
{{ if lt $index (sub (len $pages) 1) }}
{{ $pageNext := index $pages (add $index 1) }}
{{ $depthNext = len (split (strings.TrimPrefix &amp;#34;/&amp;#34; $pageNext) &amp;#34;/&amp;#34;) }}
{{ end }}
{{ if or (le $depth $depthPrev) (eq $index 0) }}
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">li&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ end }}
{{ if and (gt $depth $depthPrev) (ne $index 0) }}
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">ul&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;list-categories&amp;#34;&lt;/span> &lt;span class="na">style&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;display: block;&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">li&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ end }} {{ $name := index $sections $index }}
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">div&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;category-item&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ .LinkTitle | default $name}}
{{ if $.Site.Params.displayPostsCount }}
{{ $sectionPage := .CurrentSection }}
{{$.Scratch.Delete &amp;#34;pages&amp;#34; }}
{{ range $.Site.RegularPages }}
{{ if (.IsDescendant $sectionPage)}}
{{ $.Scratch.Add &amp;#34;pages&amp;#34; (slice .) }}
{{ end}} {{ end }}
{{ $pages := $.Scratch.Get &amp;#34;pages&amp;#34;}}
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">span&lt;/span> &lt;span class="na">class&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s">&amp;#34;category-count&amp;#34;&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{printf &amp;#34;(%d)&amp;#34; (len $pages)}}
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">span&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ end }}
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ if $.Site.Params.displayPosts }}
{{ $sectionPage := .CurrentSection }}
{{ $.Scratch.Delete &amp;#34;pages&amp;#34;}}
{{ range $.Site.RegularPages }}
{{ if (.InSection $sectionPage)}}
{{ $.Scratch.Add &amp;#34;pages&amp;#34; (slice .) }}
{{ end }} {{ end }}
{{ $pages := $.Scratch.Get &amp;#34;pages&amp;#34; }}
{{ partial &amp;#34;utils/limit-tree-posts.html&amp;#34; (dict &amp;#34;$&amp;#34; $ &amp;#34;pages&amp;#34; $pages
&amp;#34;linkTarget&amp;#34; $linkTarget) }}
{{ end }}
{{ if and (gt $depth $depthNext) (ne $index (sub (len $pages) 1)) }}
{{ range seq (sub $depth $depthNext) }}
{{ if le . (sub $depth $depthNext) }}
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">li&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">ul&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ end }} {{ end }} {{ end }} {{ if ge $depth $depthNext
}}
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">li&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
{{ end }} {{ end }} {{ end }}
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">ul&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">div&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">main&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="p">&amp;lt;&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;span class="kd">let&lt;/span> &lt;span class="nx">lis&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nb">document&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">querySelectorAll&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ul.list-categories &amp;gt; li&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">lis&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">forEach&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="nx">li&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">li&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">querySelector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;.category-item&amp;#34;&lt;/span>&lt;span class="p">).&lt;/span>&lt;span class="nx">addEventListener&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;click&amp;#34;&lt;/span>&lt;span class="p">,&lt;/span> &lt;span class="nx">event&lt;/span> &lt;span class="p">=&amp;gt;&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">event&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">stopPropagation&lt;/span>&lt;span class="p">();&lt;/span> &lt;span class="c1">// 阻止事件冒泡
&lt;/span>&lt;span class="c1">&lt;/span> &lt;span class="kd">let&lt;/span> &lt;span class="nx">sonul&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">li&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">querySelector&lt;/span>&lt;span class="p">(&lt;/span>&lt;span class="s2">&amp;#34;ul&amp;#34;&lt;/span>&lt;span class="p">);&lt;/span>
&lt;span class="nx">sonul&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">style&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">display&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">sonul&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">style&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">display&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;block&amp;#34;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="s2">&amp;#34;none&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;block&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="k">if&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="nx">sonul&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nextElementSibling&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="p">{&lt;/span>
&lt;span class="nx">sonul&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nextElementSibling&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">style&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">display&lt;/span> &lt;span class="o">=&lt;/span> &lt;span class="nx">sonul&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">nextElementSibling&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">style&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">display&lt;/span> &lt;span class="o">===&lt;/span> &lt;span class="s2">&amp;#34;block&amp;#34;&lt;/span> &lt;span class="o">?&lt;/span> &lt;span class="s2">&amp;#34;none&amp;#34;&lt;/span> &lt;span class="o">:&lt;/span> &lt;span class="s2">&amp;#34;block&amp;#34;&lt;/span>&lt;span class="p">;&lt;/span>
&lt;span class="p">}&lt;/span>
&lt;span class="p">});&lt;/span>
&lt;span class="p">})&lt;/span>
&lt;span class="p">&amp;lt;/&lt;/span>&lt;span class="nt">script&lt;/span>&lt;span class="p">&amp;gt;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-toml" data-lang="toml">
&lt;span class="p">[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">]&lt;/span>
&lt;span class="c">## 菜单栏&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;span class="nx">pageref&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;/posts/&amp;#34;&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Posts&amp;#34;&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">2&lt;/span>
&lt;span class="nx">pre&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;internal&amp;#34;&lt;/span>
&lt;span class="nx">post&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;archive&amp;#34;&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;span class="nx">pageref&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;/tags/&amp;#34;&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Tags&amp;#34;&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">4&lt;/span>
&lt;span class="nx">pre&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;internal&amp;#34;&lt;/span>
&lt;span class="nx">post&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;tags&amp;#34;&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;span class="nx">pageref&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;/about/&amp;#34;&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;About&amp;#34;&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">5&lt;/span>
&lt;span class="nx">pre&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;internal&amp;#34;&lt;/span>
&lt;span class="nx">post&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;user-circle&amp;#34;&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span> &lt;span class="c"># add wiki page&lt;/span>
&lt;span class="nx">pageref&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;/wiki/&amp;#34;&lt;/span>
&lt;span class="nx">name&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;Wiki&amp;#34;&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">6&lt;/span>
&lt;span class="nx">pre&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;internal&amp;#34;&lt;/span>
&lt;span class="nx">post&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;wiki&amp;#34;&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">7&lt;/span>
&lt;span class="nx">identifier&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;theme-switcher&amp;#34;&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">8&lt;/span>
&lt;span class="nx">identifier&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;lang-switcher&amp;#34;&lt;/span>
&lt;span class="p">[[&lt;/span>&lt;span class="nx">menu&lt;/span>&lt;span class="p">.&lt;/span>&lt;span class="nx">main&lt;/span>&lt;span class="p">]]&lt;/span>
&lt;span class="nx">weight&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="mi">9&lt;/span>
&lt;span class="nx">identifier&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;search&amp;#34;&lt;/span>
&lt;span class="nx">post&lt;/span> &lt;span class="p">=&lt;/span> &lt;span class="s2">&amp;#34;search&amp;#34;&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;h3 id="hugo--algolia-search">Hugo + Algolia search&lt;/h3>
&lt;p>Algolia 可以提供 AI 搜索服务，但需要在更新站点时用 POST 请求上传 algolia.json(站点信息)给 Algolia，以帮助 Algolia 实现搜索服务。按照要求新建站点以及配置 api 即可，上传 algolia.json 可以使用&lt;a href="https://github.com/replicatedhq/hugo-algolia">hugo-algolia&lt;/a>。因为MeME主题有一定的algolia search支持，下面仅给出上传algolia.json方面的配置。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ npm install hugo-algolia
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>但 hugo-algolia 的 toml 解析在我这里好像有点问题，可能是 config.toml 的配置已经太乱了，无法优雅地解决&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ hugo-algolia -s -t --config config.toml
JSON index file was created in public/algolia.json
/usr/local/lib/node_modules/hugo-algolia/node_modules/algoliasearch/src/AlgoliaSearchCore.js:50
throw new errors.AlgoliaSearchError&lt;span class="o">(&lt;/span>&lt;span class="s1">&amp;#39;Please provide an application ID. &amp;#39;&lt;/span> + usage&lt;span class="o">)&lt;/span>&lt;span class="p">;&lt;/span>
^
AlgoliaSearchError: Please provide an application ID. Usage: algoliasearch&lt;span class="o">(&lt;/span>applicationID, apiKey, opts&lt;span class="o">)&lt;/span>
at AlgoliaSearchNodeJS.AlgoliaSearchCore &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/node_modules/algoliasearch/src/AlgoliaSearchCore.js:50:11&lt;span class="o">)&lt;/span>
at AlgoliaSearchNodeJS.AlgoliaSearch &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/node_modules/algoliasearch/src/AlgoliaSearch.js:11:21&lt;span class="o">)&lt;/span>
at AlgoliaSearchNodeJS.AlgoliaSearchServer &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/node_modules/algoliasearch/src/server/builds/AlgoliaSearchServer.js:17:17&lt;span class="o">)&lt;/span>
at new AlgoliaSearchNodeJS &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/node_modules/algoliasearch/src/server/builds/node.js:83:23&lt;span class="o">)&lt;/span>
at algoliasearch &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/node_modules/algoliasearch/src/server/builds/node.js:68:10&lt;span class="o">)&lt;/span>
at HugoAlgolia.HugoAlgolia.sendIndex &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/lib/index.js:184:20&lt;span class="o">)&lt;/span>
at HugoAlgolia.HugoAlgolia.index &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/lib/index.js:122:12&lt;span class="o">)&lt;/span>
at Object.&amp;lt;anonymous&amp;gt; &lt;span class="o">(&lt;/span>/usr/local/lib/node_modules/hugo-algolia/bin/index.js:23:26&lt;span class="o">)&lt;/span>
at Module._compile &lt;span class="o">(&lt;/span>internal/modules/cjs/loader.js:999:30&lt;span class="o">)&lt;/span>
at Object.Module._extensions..js &lt;span class="o">(&lt;/span>internal/modules/cjs/loader.js:1027:10&lt;span class="o">)&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>无奈之下新建了一个 config.yaml&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">baseurl&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;/&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">DefaultContentLanguage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;zh-cn&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">hasCJKLanguage&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">languageCode&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;zh-cn&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">title&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;loomt&amp;#39;s Blog&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">theme&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;MeME&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">metaDataFormat&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;yaml&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nt">algolia&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">index&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;your index&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">key&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;your admin key&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">  &lt;/span>&lt;span class="nt">appID&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;your appID&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;span class="w">&lt;/span>&lt;span class="nn">---&lt;/span>&lt;span class="w">
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">$ hugo-algolia -s
JSON index file was created in public/algolia.json
&lt;span class="o">{&lt;/span> updatedAt: &lt;span class="s1">&amp;#39;2023-01-12T14:40:31.454Z&amp;#39;&lt;/span>, taskID: &lt;span class="m">173970040001&lt;/span> &lt;span class="o">}&lt;/span>
&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;blockquote>
&lt;p>用 Vercel 还有一个原因是白嫖国外的服务器不用备案😭&lt;/p>
&lt;/blockquote>
&lt;p>&lt;em>reference&lt;/em>&lt;/p>
&lt;p>&lt;a href="https://gohugo.io/getting-started">https://gohugo.io/getting-started&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://blog.aozaki.cc/blog/hugo-deployment-debugging">https://blog.aozaki.cc/blog/hugo-deployment-debugging&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://io-oi.me/tech/hugo-vs-hexo">https://io-oi.me/tech/hugo-vs-hexo&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/MunifTanjim/minimo/issues/189">https://github.com/MunifTanjim/minimo/issues/189&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://zenlian.github.io/posts/tools/github-actions-hugo">https://zenlian.github.io/posts/tools/github-actions-hugo&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://github.com/peaceiris/actions-gh-pages">https://github.com/peaceiris/actions-gh-pages&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://gohugo.io/content-management/sections">https://gohugo.io/content-management/sections&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://gohugo.io/templates">https://gohugo.io/templates&lt;/a>&lt;/p>
&lt;p>&lt;a href="https://gohugo.io/hugo-pipes">https://gohugo.io/hugo-pipes&lt;/a>&lt;/p></content><category scheme="https://loomt.top/posts/" term="posts" label="posts"/><category scheme="https://loomt.top/tags/github-page/" term="Github Page" label="Github Page"/><category scheme="https://loomt.top/tags/%E5%BB%BA%E7%AB%99/" term="建站" label="建站"/></entry></feed>