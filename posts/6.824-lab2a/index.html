<!doctype html><html lang=zh-cn><head prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#"><meta charset=utf-8><meta name=generator content="Hugo 0.92.2"><meta name=theme-color content="#16171d"><meta name=color-scheme content="light dark"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=format-detection content="telephone=no, date=no, address=no, email=no"><meta http-equiv=cache-control content="no-transform"><meta http-equiv=cache-control content="no-siteapp"><title>6.824 Lab2A | loomt</title><link rel=stylesheet href=../../css/meme.min.2d1275436de888933e161a9cf7dfaef61d659cdcd700274b0b4e30e727d63edf.css><script src=https://cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js defer></script><script src=../../js/meme.min.745066f0425636e40b3177aa258a09034534b259b19db0bd4c7bd42861e2d67f.js></script>
<link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap" media=print onload="this.media='all'"><noscript><link rel=stylesheet href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,500;0,700;1,400;1,700&family=Noto+Serif+SC:wght@400;500;700&family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"></noscript><meta name=author content="loomt"><meta name=description content="Task 完成各种情况的领导人选举。 我们首先需要熟悉一下 Raft 的工作原理，建议先过一遍 前置芝士。 Step 先完善 Raft 结构和 Make 函数，再结合 Gif 思考单个节点的状态。 节点开始时的状态是 Fol…"><link rel="shortcut icon" href=../../favicon.ico type=image/x-icon><link rel=mask-icon href=../../icons/safari-pinned-tab.svg color=#2a6df4><link rel=apple-touch-icon sizes=180x180 href=../../icons/apple-touch-icon.png><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-title content="loomt"><meta name=apple-mobile-web-app-status-bar-style content="black"><meta name=mobile-web-app-capable content="yes"><meta name=application-name content="loomt"><meta name=msapplication-starturl content="../../"><meta name=msapplication-TileColor content="#fff"><meta name=msapplication-TileImage content="../../icons/mstile-150x150.png"><link rel=manifest href=../../manifest.json><link rel=canonical href=https://loomt.top/posts/6.824-lab2a/><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","datePublished":"2023-03-03T14:57:12+08:00","dateModified":"2023-03-08T18:44:28+08:00","url":"https://loomt.top/posts/6.824-lab2a/","headline":"6.824 Lab2A","description":"Task 完成各种情况的领导人选举。 我们首先需要熟悉一下 Raft 的工作原理，建议先过一遍 前置芝士。 Step 先完善 Raft 结构和 Make 函数，再结合 Gif 思考单个节点的状态。 节点开始时的状态是 Fol…","inLanguage":"zh-CN","articleSection":"posts","wordCount":933,"image":"https://loomt.top/icons/apple-touch-icon.png","author":{"@type":"Person","description":"du^du^lu~","email":"loomt_@outlook.com","image":"https://loomt.top/icons/apple-touch-icon.png","url":"https://loomt.top","name":"loomt"},"license":"[CC BY-NC-SA 4.0](https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh)","publisher":{"@type":"Organization","name":"loomt","logo":{"@type":"ImageObject","url":"https://loomt.top/icons/apple-touch-icon.png"},"url":"https://loomt.top"},"mainEntityOfPage":{"@type":"WebSite","@id":"https://loomt.top"}}</script><meta name=twitter:card content="summary"><meta name=twitter:site content="@loomt"><meta name=twitter:creator content="@loomt"><meta property="og:title" content="6.824 Lab2A"><meta property="og:description" content="Task 完成各种情况的领导人选举。 我们首先需要熟悉一下 Raft 的工作原理，建议先过一遍 前置芝士。 Step 先完善 Raft 结构和 Make 函数，再结合 Gif 思考单个节点的状态。 节点开始时的状态是 Fol…"><meta property="og:url" content="https://loomt.top/posts/6.824-lab2a/"><meta property="og:site_name" content="loomt"><meta property="og:locale" content="zh"><meta property="og:image" content="https://loomt.top/icons/apple-touch-icon.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2023-03-03T14:57:12+08:00"><meta property="article:modified_time" content="2023-03-08T18:44:28+08:00"><meta property="article:section" content="posts"><link rel=preconnect href=https://www.google-analytics.com crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=4408417667"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag('js',new Date),gtag('config','4408417667')</script></head><body><div class=container><header class=header><div class=header-wrapper><div class="header-inner single"><div class=site-brand><a href=../../ class=brand>loomt</a></div><nav class=nav><ul class=menu id=menu><li class="menu-item
active"><a href=../../posts/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon archive"><path d="M32 448c0 17.7 14.3 32 32 32h384c17.7.0 32-14.3 32-32V160H32v288zm160-212c0-6.6 5.4-12 12-12h104c6.6.0 12 5.4 12 12v8c0 6.6-5.4 12-12 12H204c-6.6.0-12-5.4-12-12v-8zM480 32H32C14.3 32 0 46.3.0 64v48c0 8.8 7.2 16 16 16h480c8.8.0 16-7.2 16-16V64c0-17.7-14.3-32-32-32z"/></svg><span class=menu-item-name>Posts</span></a></li><li class=menu-item><a href=../../tags/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon tags"><path d="M497.941 225.941 286.059 14.059A48 48 0 00252.118.0H48C21.49.0.0 21.49.0 48v204.118a48 48 0 0014.059 33.941l211.882 211.882c18.744 18.745 49.136 18.746 67.882.0l204.118-204.118c18.745-18.745 18.745-49.137.0-67.882zM112 160c-26.51.0-48-21.49-48-48s21.49-48 48-48 48 21.49 48 48-21.49 48-48 48zm513.941 133.823L421.823 497.941c-18.745 18.745-49.137 18.745-67.882.0l-.36-.36L527.64 323.522c16.999-16.999 26.36-39.6 26.36-63.64s-9.362-46.641-26.36-63.64L331.397.0h48.721a48 48 0 0133.941 14.059l211.882 211.882c18.745 18.745 18.745 49.137.0 67.882z"/></svg><span class=menu-item-name>Tags</span></a></li><li class=menu-item><a href=../../about/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512" class="icon user-circle"><path d="M248 8C111 8 0 119 0 256s111 248 248 248 248-111 248-248S385 8 248 8zm0 96c48.6.0 88 39.4 88 88s-39.4 88-88 88-88-39.4-88-88 39.4-88 88-88zm0 344c-58.7.0-111.3-26.6-146.5-68.2 18.8-35.4 55.6-59.8 98.5-59.8 2.4.0 4.8.4 7.1 1.1 13 4.2 26.6 6.9 40.9 6.9s28-2.7 40.9-6.9c2.3-.7 4.7-1.1 7.1-1.1 42.9.0 79.7 24.4 98.5 59.8C359.3 421.4 306.7 448 248 448z"/></svg><span class=menu-item-name>About</span></a></li><li class=menu-item><a href=../../wiki/><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512" class="icon wiki"><path d="M640 51.2l-.3 12.2c-28.1.8-45 15.8-55.8 40.3-25 57.8-103.3 240-155.3 358.6H415l-81.9-193.1c-32.5 63.6-68.3 130-99.2 193.1-.3.3-15 0-15-.3C172 352.3 122.8 243.4 75.8 133.4 64.4 106.7 26.4 63.4.2 63.7c0-3.1-.3-10-.3-14.2h161.9v13.9c-19.2 1.1-52.8 13.3-43.3 34.2 21.9 49.7 103.6 240.3 125.6 288.6 15-29.7 57.8-109.2 75.3-142.8-13.9-28.3-58.6-133.9-72.8-160-9.7-17.8-36.1-19.4-55.8-19.7V49.8l142.5.3v13.1c-19.4.6-38.1 7.8-29.4 26.1 18.9 40 30.6 68.1 48.1 104.7 5.6-10.8 34.7-69.4 48.1-100.8 8.9-20.6-3.9-28.6-38.6-29.4.3-3.6.0-10.3.3-13.6 44.4-.3 111.1-.3 123.1-.6v13.6c-22.5.8-45.8 12.8-58.1 31.7l-59.2 122.8c6.4 16.1 63.3 142.8 69.2 156.7L559.2 91.8c-8.6-23.1-36.4-28.1-47.2-28.3V49.6l127.8 1.1.2.5z"/></svg><span class=menu-item-name>Wiki</span></a></li><li class=menu-item><a id=theme-switcher href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-light"><path d="M193.2 104.5 242 7a18 18 0 0128 0l48.8 97.5L422.2 70A18 18 0 01442 89.8l-34.5 103.4L505 242a18 18 0 010 28l-97.5 48.8L442 422.2A18 18 0 01422.2 442l-103.4-34.5L270 505a18 18 0 01-28 0l-48.8-97.5L89.8 442A18 18 0 0170 422.2l34.5-103.4-97.5-48.8a18 18 0 010-28l97.5-48.8L70 89.8A18 18 0 0189.8 70zM256 128a128 128 0 10.01.0M256 160a96 96 0 10.01.0"/></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon theme-icon-dark"><path d="M27 412A256 256 0 10181 5a11.5 11.5.0 00-5 20A201.5 201.5.0 0142 399a11.5 11.5.0 00-15 13"/></svg></a></li><li class="menu-item search-item"><form id=search class=search role=search><label for=search-input><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon search-icon"><path d="M505 442.7 405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9.0 208 0S0 93.1.0 208s93.1 208 208 208c48.3.0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9.0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7.0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7.0 128 57.2 128 128 0 70.7-57.2 128-128 128z"/></svg></label><input type=search id=search-input class=search-input></form><template id=search-result hidden><article class="content post"><h2 class=post-title><a class=summary-title-link></a></h2><summary class=summary></summary><div class=read-more-container><a class=read-more-link>Read More »</a></div></article></template></li></ul></nav></div></div><input type=checkbox id=nav-toggle aria-hidden=true>
<label for=nav-toggle class=nav-toggle></label>
<label for=nav-toggle class=nav-curtain></label></header><main class="main single" id=main><div class=main-inner><article class="content post h-entry" data-align=justify data-type=posts><h1 class="post-title p-name">6.824 Lab2A</h1><div class=post-meta><time datetime=2023-03-03T14:57:12+08:00 class="post-meta-item published dt-published"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon post-meta-icon"><path d="M148 288h-40c-6.6.0-12-5.4-12-12v-40c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v40c0 6.6-5.4 12-12 12zm108-12v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 96v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm-96 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm192 0v-40c0-6.6-5.4-12-12-12h-40c-6.6.0-12 5.4-12 12v40c0 6.6 5.4 12 12 12h40c6.6.0 12-5.4 12-12zm96-260v352c0 26.5-21.5 48-48 48H48c-26.5.0-48-21.5-48-48V112c0-26.5 21.5-48 48-48h48V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h128V12c0-6.6 5.4-12 12-12h40c6.6.0 12 5.4 12 12v52h48c26.5.0 48 21.5 48 48zm-48 346V160H48v298c0 3.3 2.7 6 6 6h340c3.3.0 6-2.7 6-6z"/></svg>&nbsp;2023.3.3</time>
<span class="post-meta-item wordcount"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M497.9 142.1l-46.1 46.1c-4.7 4.7-12.3 4.7-17 0l-111-111c-4.7-4.7-4.7-12.3.0-17l46.1-46.1c18.7-18.7 49.1-18.7 67.9.0l60.1 60.1c18.8 18.7 18.8 49.1.0 67.9zM284.2 99.8 21.6 362.4.4 483.9c-2.9 16.4 11.4 30.6 27.8 27.8l121.5-21.3 262.6-262.6c4.7-4.7 4.7-12.3.0-17l-111-111c-4.8-4.7-12.4-4.7-17.1.0zM124.1 339.9c-5.5-5.5-5.5-14.3.0-19.8l154-154c5.5-5.5 14.3-5.5 19.8.0s5.5 14.3.0 19.8l-154 154c-5.5 5.5-14.3 5.5-19.8.0zM88 424h48v36.3l-64.5 11.3-31.1-31.1L51.7 376H88v48z"/></svg>&nbsp;933</span>
<span class="post-meta-item reading-time"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon post-meta-icon"><path d="M256 8C119 8 8 119 8 256s111 248 248 248 248-111 248-248S393 8 256 8zm0 448c-110.5.0-2e2-89.5-2e2-2e2S145.5 56 256 56s2e2 89.5 2e2 2e2-89.5 2e2-2e2 2e2zm61.8-104.4-84.9-61.7c-3.1-2.3-4.9-5.9-4.9-9.7V116c0-6.6 5.4-12 12-12h32c6.6.0 12 5.4 12 12v141.7l66.8 48.6c5.4 3.9 6.5 11.4 2.6 16.8L334.6 349c-3.9 5.3-11.4 6.5-16.8 2.6z"/></svg>&nbsp;2&nbsp;mins</span></div><nav class=contents><h2 id=contents class=contents-title>Contents</h2><ol class=toc><li><a href=#step>Step</a></li><li><a href=#tips>Tips</a></li></ol></nav><div class="post-body e-content"><h1 id=task><a href=#task class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Task</h1><p>完成各种情况的领导人选举。</p><p>我们首先需要熟悉一下 Raft 的工作原理，建议先过一遍 <a href=https://loomt.top/posts/6.824-lab2 target=_blank rel=noopener>前置芝士</a>。</p><h2 id=step><a href=#step class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Step</h2><ol><li>先完善 Raft 结构和 Make 函数，再结合 <a href=http://thesecretlivesofdata.com/raft/ target=_blank rel=noopener>Gif</a> 思考单个节点的状态。</li><li>节点开始时的状态是 Follower，election timeout 后，状态会改为 Candidate。我们应该如何设计选举超时，当然是开一个 go routine<code>rf.ticker()</code> 对超时进行检测。那么是用<code>time.Sleep</code>还是<code>time.Timer</code>实现呢？官方的建议是用 sleep，但我用的是 timer，也能够正常实现，并且我还实现了 sleep 的版本，感觉速度上相差无几。</li></ol><ul><li>ticker</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>ticker</span><span class=p>()</span> <span class=p>{</span>
	<span class=k>for</span> <span class=p>!</span><span class=nx>rf</span><span class=p>.</span><span class=nf>killed</span><span class=p>()</span> <span class=p>{</span>
		<span class=k>select</span> <span class=p>{</span>
		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>rf</span><span class=p>.</span><span class=nx>heartbeatTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
			<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>Leader</span> <span class=p>{</span>
				<span class=nx>rf</span><span class=p>.</span><span class=nf>startHeartbeatL</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span>
				<span class=nx>rf</span><span class=p>.</span><span class=nx>heartbeatTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>getHeartbeatDuration</span><span class=p>())</span>
				<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>getElectionDuration</span><span class=p>())</span>
			<span class=p>}</span>
			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
		<span class=k>case</span> <span class=o>&lt;-</span><span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nx>C</span><span class=p>:</span>
			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
			<span class=nx>rf</span><span class=p>.</span><span class=nf>startElectionL</span><span class=p>()</span>
			<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>getElectionDuration</span><span class=p>())</span>
			<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><ol start=3><li>节点成为 Candidate 后并发发送 RequestVote RPC，自己如何处理 RPC 返回的结果，如何判断投给自己的节点数量是否超过半数？</li></ol><ul><li>Leader election</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go>
<span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>foraVote</span><span class=p>(</span><span class=nx>peer</span> <span class=kt>int</span><span class=p>,</span> <span class=nx>args</span> <span class=o>*</span><span class=nx>RequestVoteArgs</span><span class=p>,</span> <span class=nx>cnt</span> <span class=o>*</span><span class=kt>int</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>reply</span> <span class=o>:=</span> <span class=nx>RequestVoteReply</span><span class=p>{}</span>
	<span class=nf>DPrintf</span><span class=p>(</span><span class=nx>dVote</span><span class=p>,</span> <span class=s>&#34;S%v -&gt; S%v send vote&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>peer</span><span class=p>)</span>
	<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>sendRequestVote</span><span class=p>(</span><span class=nx>peer</span><span class=p>,</span> <span class=nx>args</span><span class=p>,</span> <span class=o>&amp;</span><span class=nx>reply</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
		<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
		<span class=k>if</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>state</span> <span class=o>==</span> <span class=nx>Candidate</span> <span class=p>{</span>
			<span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>{</span>
				<span class=nf>DPrintf</span><span class=p>(</span><span class=nx>dVote</span><span class=p>,</span> <span class=s>&#34;S%v &lt;- S%v voted&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>peer</span><span class=p>)</span>
				<span class=o>*</span><span class=nx>cnt</span><span class=o>++</span>
				<span class=k>if</span> <span class=o>*</span><span class=nx>cnt</span> <span class=p>&gt;</span> <span class=nb>len</span><span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span><span class=p>)</span><span class=o>/</span><span class=mi>2</span> <span class=p>{</span>
					<span class=k>for</span> <span class=nx>i</span> <span class=o>:=</span> <span class=k>range</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>peers</span> <span class=p>{</span>
						<span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLogL</span><span class=p>().</span><span class=nx>Index</span> <span class=o>+</span> <span class=mi>1</span>
						<span class=nx>rf</span><span class=p>.</span><span class=nx>matchIndex</span><span class=p>[</span><span class=nx>i</span><span class=p>]</span> <span class=p>=</span> <span class=mi>0</span>
						<span class=nf>DPrintf</span><span class=p>(</span><span class=nx>dHeart</span><span class=p>,</span> <span class=s>&#34;S%v &lt;- S%v nextIndex:%v&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>i</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>nextIndex</span><span class=p>[</span><span class=nx>i</span><span class=p>])</span>
					<span class=p>}</span>
					<span class=nx>rf</span><span class=p>.</span><span class=nf>changeStateL</span><span class=p>(</span><span class=nx>Leader</span><span class=p>)</span>
				<span class=p>}</span>
			<span class=p>}</span> <span class=k>else</span> <span class=k>if</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>{</span>
				<span class=nf>DPrintf</span><span class=p>(</span><span class=nx>dVote</span><span class=p>,</span> <span class=s>&#34;S%v &lt;- S%v ~voted&#34;</span><span class=p>,</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>me</span><span class=p>,</span> <span class=nx>peer</span><span class=p>)</span>
				<span class=nx>rf</span><span class=p>.</span><span class=nf>changeStateL</span><span class=p>(</span><span class=nx>Follower</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>NULL</span><span class=p>)</span>
				<span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>()</span>
			<span class=p>}</span>
		<span class=p>}</span>
	<span class=p>}</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><ol start=4><li>peer 节点从哪些方面处理投票逻辑，任期？日志情况（2B）？</li></ol><ul><li>Follower RequestVote RPC handler</li></ul><div class=highlight><div class=chroma><div class=table-container><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-go data-lang=go><span class=kd>func</span> <span class=p>(</span><span class=nx>rf</span> <span class=o>*</span><span class=nx>Raft</span><span class=p>)</span> <span class=nf>RequestVote</span><span class=p>(</span><span class=nx>args</span> <span class=o>*</span><span class=nx>RequestVoteArgs</span><span class=p>,</span> <span class=nx>reply</span> <span class=o>*</span><span class=nx>RequestVoteReply</span><span class=p>)</span> <span class=p>{</span>
	<span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Lock</span><span class=p>()</span>
	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>mu</span><span class=p>.</span><span class=nf>Unlock</span><span class=p>()</span>
	<span class=k>defer</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>persist</span><span class=p>()</span>
	<span class=c1>// currTerm higher || voted
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>&gt;</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=o>||</span> <span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nx>votedFor</span> <span class=o>!=</span> <span class=nx>NULL</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=o>==</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
		<span class=k>return</span>
	<span class=p>}</span>
	<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span> <span class=p>&lt;</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span> <span class=p>{</span>
		<span class=nx>rf</span><span class=p>.</span><span class=nf>changeStateL</span><span class=p>(</span><span class=nx>Follower</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>NULL</span><span class=p>)</span>
	<span class=p>}</span>
	<span class=c1>//  check log leader
</span><span class=c1></span>	<span class=c1>//  candidate lastLogTerm to short || (lastLogTerm=rf.lastLogTerm &amp;&amp; candidate lastLogIndex to short)
</span><span class=c1></span>	<span class=k>if</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLogL</span><span class=p>().</span><span class=nx>Term</span> <span class=p>&gt;</span> <span class=nx>args</span><span class=p>.</span><span class=nx>LastLogTerm</span> <span class=o>||</span> <span class=p>(</span><span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLogL</span><span class=p>().</span><span class=nx>Term</span> <span class=o>==</span> <span class=nx>args</span><span class=p>.</span><span class=nx>LastLogTerm</span> <span class=o>&amp;&amp;</span> <span class=nx>rf</span><span class=p>.</span><span class=nf>getLastLogL</span><span class=p>().</span><span class=nx>Index</span> <span class=p>&gt;</span> <span class=nx>args</span><span class=p>.</span><span class=nx>LastLogIndex</span><span class=p>)</span> <span class=p>{</span>
		<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>false</span>
		<span class=k>return</span>
	<span class=p>}</span>
	<span class=nx>rf</span><span class=p>.</span><span class=nf>changeStateL</span><span class=p>(</span><span class=nx>Follower</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>args</span><span class=p>.</span><span class=nx>CandidateId</span><span class=p>)</span>
	<span class=nx>rf</span><span class=p>.</span><span class=nx>electionTimer</span><span class=p>.</span><span class=nf>Reset</span><span class=p>(</span><span class=nf>getElectionDuration</span><span class=p>())</span>
	<span class=nx>reply</span><span class=p>.</span><span class=nx>Term</span><span class=p>,</span> <span class=nx>reply</span><span class=p>.</span><span class=nx>VoteGranted</span> <span class=p>=</span> <span class=nx>rf</span><span class=p>.</span><span class=nx>currentTerm</span><span class=p>,</span> <span class=kc>true</span>
<span class=p>}</span>
</code></pre></td></tr></table></div></div></div><h2 id=tips><a href=#tips class=anchor-link><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon anchor-icon"><path d="M326.612 185.391c59.747 59.809 58.927 155.698.36 214.59-.11.12-.24.25-.36.37l-67.2 67.2c-59.27 59.27-155.699 59.262-214.96.0-59.27-59.26-59.27-155.7.0-214.96l37.106-37.106c9.84-9.84 26.786-3.3 27.294 10.606.648 17.722 3.826 35.527 9.69 52.721 1.986 5.822.567 12.262-3.783 16.612l-13.087 13.087c-28.026 28.026-28.905 73.66-1.155 101.96 28.024 28.579 74.086 28.749 102.325.51l67.2-67.19c28.191-28.191 28.073-73.757.0-101.83-3.701-3.694-7.429-6.564-10.341-8.569a16.037 16.037.0 01-6.947-12.606c-.396-10.567 3.348-21.456 11.698-29.806l21.054-21.055c5.521-5.521 14.182-6.199 20.584-1.731a152.482 152.482.0 0120.522 17.197zM467.547 44.449c-59.261-59.262-155.69-59.27-214.96.0l-67.2 67.2c-.12.12-.25.25-.36.37-58.566 58.892-59.387 154.781.36 214.59a152.454 152.454.0 0020.521 17.196c6.402 4.468 15.064 3.789 20.584-1.731l21.054-21.055c8.35-8.35 12.094-19.239 11.698-29.806a16.037 16.037.0 00-6.947-12.606c-2.912-2.005-6.64-4.875-10.341-8.569-28.073-28.073-28.191-73.639.0-101.83l67.2-67.19c28.239-28.239 74.3-28.069 102.325.51 27.75 28.3 26.872 73.934-1.155 101.96l-13.087 13.087c-4.35 4.35-5.769 10.79-3.783 16.612 5.864 17.194 9.042 34.999 9.69 52.721.509 13.906 17.454 20.446 27.294 10.606l37.106-37.106c59.271-59.259 59.271-155.699.001-214.959z"/></svg></a>Tips</h2><ol><li><p>Candidate 选举前要先自增 <code>currentTerm</code>。</p></li><li><p>在 2A 中，我们处理 RequestVote Handler 的时候还不需要关注日志的新旧（2B），rf.persist() 也还不需要关注（2C），仅需要思考任期应该如何处理。</p></li><li><p>因为处理投票 RPC 的返回时需要加锁保证 rf 结构的原子读取和写入，顺便就可以进行投票数量的计数。</p></li><li><p>Candidate 成为 Leader 时，需要及时发送 heartbeat，告诉别人自己是老大，阻止他们的选举。</p></li><li><p>heartbeat 频率不能太高，控制在每秒 10 次以内，否则会突然宕机（但其实我亲测 heartbeatTimeout 设为 60ms，election 设为 rand(180)+180，test 了 1k 次没一次是 fail 的）。</p><blockquote><p>The paper&rsquo;s Section 5.2 mentions election timeouts in the range of 150 to 300 milliseconds. Such a range only makes sense if the Leader sends heartbeats considerably more often than once per 150 milliseconds (e.g., once per 10 milliseconds). Because the tester limits you tens of heartbeats per second, you will have to use an election timeout larger than the paper&rsquo;s 150 to 300 milliseconds, but not too large, because then you may fail to elect a Leader within five seconds.</p></blockquote></li></ol></div><ul class=post-copyright><li class="copyright-item author"><span class=copyright-item-text>Author</span>: <a href=https://loomt.top class="p-author h-card" target=_blank rel=noopener>loomt</a></li><li class="copyright-item link"><span class=copyright-item-text>Link</span>: <a href=../../posts/6.824-lab2a/ target=_blank rel=noopener>https://loomt.top/posts/6.824-lab2a/</a></li><li class="copyright-item license"><span class=copyright-item-text>License</span>: <a href=https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh target=_blank rel=noopener>CC BY-NC-SA 4.0</a></li></ul></article><div class=updated-badge-container><span title="Updated @ 2023-03-08 18:44:28 +0800" style=cursor:help><svg xmlns="http://www.w3.org/2000/svg" width="130" height="20" class="updated-badge"><linearGradient id="b" x2="0" y2="100%"><stop offset="0" stop-color="#bbb" stop-opacity=".1"/><stop offset="1" stop-opacity=".1"/></linearGradient><clipPath id="a"><rect width="130" height="20" rx="3" fill="#fff"/></clipPath><g clip-path="url(#a)"><path class="updated-badge-left" d="M0 0h55v20H0z"/><path class="updated-badge-right" d="M55 0h75v20H55z"/><path fill="url(#b)" d="M0 0h130v20H0z"/></g><g fill="#fff" text-anchor="middle" font-size="110"><text x="285" y="150" fill="#010101" fill-opacity=".3" textLength="450" transform="scale(.1)">updated</text><text x="285" y="140" textLength="450" transform="scale(.1)">updated</text><text x="915" y="150" fill="#010101" fill-opacity=".3" textLength="650" transform="scale(.1)">2023-03-08</text><text x="915" y="140" textLength="650" transform="scale(.1)">2023-03-08</text></g></svg></span></div><footer class=minimal-footer><div class=post-category><a href=../../posts/ class="post-category-link active">posts</a></div></footer><ul class=post-nav><li class=post-nav-prev><a href=../../posts/6.824-lab2b/ rel=prev>&lt; 6.824 Lab2B</a></li><li class=post-nav-next><a href=../../posts/6.824-lab2/ rel=next>6.824 Lab2 ></a></li></ul><div id=gitalk-container></div></div></main><div id=back-to-top class=back-to-top><a href=#><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="icon arrow-up"><path d="M34.9 289.5l-22.2-22.2c-9.4-9.4-9.4-24.6.0-33.9L207 39c9.4-9.4 24.6-9.4 33.9.0l194.3 194.3c9.4 9.4 9.4 24.6.0 33.9L413 289.4c-9.5 9.5-25 9.3-34.3-.4L264 168.6V456c0 13.3-10.7 24-24 24h-32c-13.3.0-24-10.7-24-24V168.6L69.2 289.1c-9.3 9.8-24.8 10-34.3.4z"/></svg></a></div><footer id=footer class=footer><div class=footer-inner><div class=site-info>©&nbsp;2022–2023&nbsp;<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon footer-icon"><path d="M462.3 62.6C407.5 15.9 326 24.3 275.7 76.2L256 96.5l-19.7-20.3C186.1 24.3 104.5 15.9 49.7 62.6c-62.8 53.6-66.1 149.8-9.9 207.9l193.5 199.8c12.5 12.9 32.8 12.9 45.3.0l193.5-199.8c56.3-58.1 53-154.3-9.8-207.9z"/></svg>&nbsp;loomt</div><div class=powered-by>Powered by <a href=https://github.com/gohugoio/hugo target=_blank rel=noopener>Hugo</a> | Theme is <a href=https://github.com/reuixiy/hugo-theme-meme target=_blank rel=noopener>MemE</a></div><div class=custom-footer>du^du^lu~</div><ul class=socials><li class=socials-item><a href=../../rss.xml target=_blank rel="external noopener" title=RSS><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M19.199 24C19.199 13.467 10.533 4.8.0 4.8V0c13.165.0 24 10.835 24 24h-4.801zM3.291 17.415c1.814.0 3.293 1.479 3.293 3.295.0 1.813-1.485 3.29-3.301 3.29C1.47 24 0 22.526.0 20.71s1.475-3.294 3.291-3.295zM15.909 24h-4.665c0-6.169-5.075-11.245-11.244-11.245V8.09c8.727.0 15.909 7.184 15.909 15.91z"/></svg></a></li><li class=socials-item><a href=mailto:loomt_@outlook.com target=_blank rel="external noopener" title=Email><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="icon social-icon"><path d="M464 64H48C21.49 64 0 85.49.0 112v288c0 26.51 21.49 48 48 48h416c26.51.0 48-21.49 48-48V112c0-26.51-21.49-48-48-48zm0 48v40.805c-22.422 18.259-58.168 46.651-134.587 106.49-16.841 13.247-50.201 45.072-73.413 44.701-23.208.375-56.579-31.459-73.413-44.701C106.18 199.465 70.425 171.067 48 152.805V112h416zM48 4e2V214.398c22.914 18.251 55.409 43.862 104.938 82.646 21.857 17.205 60.134 55.186 103.062 54.955 42.717.231 80.509-37.199 103.053-54.947 49.528-38.783 82.032-64.401 104.947-82.653V4e2H48z"/></svg></a></li><li class=socials-item><a href=https://github.com/loomts target=_blank rel="external noopener" title=GitHub><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="icon social-icon"><path d="M12 .297c-6.63.0-12 5.373-12 12 0 5.303 3.438 9.8 8.205 11.385.6.113.82-.258.82-.577.0-.285-.01-1.04-.015-2.04-3.338.724-4.042-1.61-4.042-1.61C4.422 18.07 3.633 17.7 3.633 17.7c-1.087-.744.084-.729.084-.729 1.205.084 1.838 1.236 1.838 1.236 1.07 1.835 2.809 1.305 3.495.998.108-.776.417-1.305.76-1.605-2.665-.3-5.466-1.332-5.466-5.93.0-1.31.465-2.38 1.235-3.22-.135-.303-.54-1.523.105-3.176.0.0 1.005-.322 3.3 1.23.96-.267 1.98-.399 3-.405 1.02.006 2.04.138 3 .405 2.28-1.552 3.285-1.23 3.285-1.23.645 1.653.24 2.873.12 3.176.765.84 1.23 1.91 1.23 3.22.0 4.61-2.805 5.625-5.475 5.92.42.36.81 1.096.81 2.22.0 1.606-.015 2.896-.015 3.286.0.315.21.69.825.57C20.565 22.092 24 17.592 24 12.297c0-6.627-5.373-12-12-12"/></svg></a></li></ul></div></footer></div><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.css><script>if(typeof renderMathInElement=='undefined'){const a=b=>{const a=document.createElement('script');a.defer=!0,a.crossOrigin='anonymous',Object.keys(b).forEach(c=>{a[c]=b[c]}),document.body.appendChild(a)};a({src:'https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/katex.min.js',onload:()=>{a({src:'https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/mhchem.min.js',onload:()=>{a({src:'https://cdn.jsdelivr.net/npm/katex@0.13.0/dist/contrib/auto-render.min.js',onload:()=>{renderKaTex()}})}})}})}else renderKaTex();function renderKaTex(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"\\[",right:"\\]",display:!0},{left:"$",right:"$",display:!1},{left:"\\(",right:"\\)",display:!1}]})}</script><script>typeof MathJax=='undefined'?(window.MathJax={loader:{load:['[tex]/mhchem']},tex:{inlineMath:{'[+]':[['$','$']]},tags:'ams',packages:{'[+]':['mhchem']}}},function(){const a=document.createElement('script');a.src='https://cdn.jsdelivr.net/npm/mathjax@3.1.2/es5/tex-mml-chtml.js',a.defer=!0,document.head.appendChild(a)}()):(MathJax.texReset(),MathJax.typeset())</script><script src=https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js></script>
<script>const mermaidConfig={startOnLoad:!0,flowchart:{useMaxWidth:!1,htmlLabels:!0},theme:'dark'};mermaid.initialize(mermaidConfig)</script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css><script>function loadComments(){if(!document.getElementById('gitalk-container'))return;if(typeof Gitalk=='undefined'){const a=b=>{const a=document.createElement('script');a.defer=!0,a.crossOrigin='anonymous',Object.keys(b).forEach(c=>{a[c]=b[c]}),document.body.appendChild(a)};a({src:'https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js',onload:()=>{newGitalk()}})}else newGitalk()}function newGitalk(){const a=new Gitalk({clientID:"26b1beb48456d1836b7f",clientSecret:"02551229705c155acbb1b2c3940636b67c6e4a35",repo:"loomts.github.io",owner:"loomts",admin:["loomts"],id:decodeURI(location.pathname),number:-1,labels:["Gitalk"],language:"zh-CN",perPage:10,distractionFreeMode:!1,pagerDirection:"last",createIssueManually:!1,proxy:"https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token",flipMoveOptions:{staggerDelayBy:150,appearAnimation:"accordionVertical",enterAnimation:"accordionVertical",leaveAnimation:"accordionVertical"},enableHotKey:!0});a.render('gitalk-container')}</script><style>.gt-container .gt-header-textarea{color:#000}</style><script src=https://cdn.jsdelivr.net/npm/medium-zoom@latest/dist/medium-zoom.min.js></script>
<script>let imgNodes=document.querySelectorAll('div.post-body img');imgNodes=Array.from(imgNodes).filter(a=>a.parentNode.tagName!=="A"),mediumZoom(imgNodes,{background:'hsla(var(--color-bg-h), var(--color-bg-s), var(--color-bg-l), 0.95)'})</script><script src=https://cdn.jsdelivr.net/npm/instant.page@5.1.0/instantpage.min.js type=module defer></script></body></html>